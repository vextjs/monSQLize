# Changelog v1.1.4

> **å‘å¸ƒæ—¥æœŸ**: 2026-02-09  
> **ç‰ˆæœ¬ç±»å‹**: åŠŸèƒ½å¢å¼º (Feature Enhancement)

---

## ğŸ‰ æ–°å¢åŠŸèƒ½

### å‡½æ•°ç¼“å­˜ (Function Cache)

æ–°å¢é€šç”¨å‡½æ•°ç¼“å­˜åŠŸèƒ½ï¼Œå…è®¸ä¸ºä»»æ„å¼‚æ­¥å‡½æ•°æ·»åŠ ç¼“å­˜èƒ½åŠ›ï¼Œä¸ä»…é™äºæ•°æ®åº“æŸ¥è¯¢ã€‚

#### æ ¸å¿ƒç‰¹æ€§

- âœ… **é›¶ä¾µå…¥è£…é¥°å™¨æ¨¡å¼** - é€šè¿‡ `withCache()` åŒ…è£…å‡½æ•°ï¼Œä¸ä¿®æ”¹åŸä»£ç 
- âœ… **FunctionCache ç±»** - ç»Ÿä¸€ç®¡ç†å¤šä¸ªå‡½æ•°çš„ç¼“å­˜
- âœ… **è‡ªåŠ¨å‚æ•°åºåˆ—åŒ–** - æ”¯æŒå¯¹è±¡ã€æ•°ç»„ã€Dateã€ObjectId ç­‰å¤æ‚ç±»å‹
- âœ… **TTL è¿‡æœŸæ§åˆ¶** - çµæ´»çš„ç¼“å­˜æ—¶é—´è®¾ç½®
- âœ… **è‡ªå®šä¹‰é”®ç”Ÿæˆå™¨** - æ”¯æŒè‡ªå®šä¹‰ç¼“å­˜é”®ç”Ÿæˆé€»è¾‘
- âœ… **å‘½åç©ºé—´éš”ç¦»** - å¤šæ¨¡å—ç¼“å­˜äº’ä¸å¹²æ‰°
- âœ… **æ¡ä»¶ç¼“å­˜** - åŸºäºè¿”å›å€¼å†³å®šæ˜¯å¦ç¼“å­˜
- âœ… **å¹¶å‘æ§åˆ¶** - é˜²æ­¢ç¼“å­˜å‡»ç©¿ï¼Œå¤šä¸ªå¹¶å‘è¯·æ±‚å…±äº«ç»“æœ
- âœ… **ç»Ÿè®¡ç›‘æ§** - å‘½ä¸­ç‡ã€è°ƒç”¨æ¬¡æ•°ã€å¹³å‡è€—æ—¶ç­‰
- âœ… **å®Œæ•´ Redis æ”¯æŒ** - ä»… Redis / æœ¬åœ° + Redis åŒå±‚ç¼“å­˜
- âœ… **é”™è¯¯å®¹é”™** - ç¼“å­˜è¯»å†™å¤±è´¥ä¸å½±å“ä¸šåŠ¡é€»è¾‘

#### API æ–°å¢

```javascript
const { withCache, FunctionCache } = require('monsqlize');

// æ–¹å¼ 1: è£…é¥°å™¨
const cached = withCache(fn, { 
    ttl: 60000, 
    cache: msq.getCache()
});

// æ–¹å¼ 2: FunctionCache ç±»
const fnCache = new FunctionCache(msq);
fnCache.register('myFunction', fn);
```

#### é›†åˆä¾èµ–è‡ªåŠ¨å¤±æ•ˆ ğŸ†•

å½“å£°æ˜ `collections` é€‰é¡¹æ—¶ï¼ŒMongoDB å†™æ“ä½œä¼šè‡ªåŠ¨å¤±æ•ˆç›¸å…³å‡½æ•°ç¼“å­˜ï¼š

```javascript
fnCache.register('getUserProfile', getUserProfileFn, {
    ttl: 300000,
    collections: ['users', 'orders']  // å£°æ˜ä¾èµ–
});

// æ•°æ®æ›´æ–°æ—¶è‡ªåŠ¨å¤±æ•ˆ
await msq.collection('users').updateOne({ _id: 'user123' }, { $set: { name: 'Alice' } });
// âœ… getUserProfile çš„ç¼“å­˜å·²è‡ªåŠ¨å¤±æ•ˆ
```

**æ”¯æŒçš„å†™æ“ä½œ**:
- updateOne, updateMany
- deleteOne, deleteMany
- insertOne, insertMany
- replaceOne, findOneAndUpdate, findOneAndDelete, findOneAndReplace

#### æ€§èƒ½æå‡

- å¤æ‚ä¸šåŠ¡å‡½æ•°ï¼š**50000x åŠ é€Ÿ**
- å¤–éƒ¨ API è°ƒç”¨ï¼š**200000-500000x åŠ é€Ÿ**
- å¤æ‚è®¡ç®—ï¼š**100000x åŠ é€Ÿ**

---

## ğŸ”§ Bug ä¿®å¤

### MultiLevelCache.delPattern å¢å¼º

**é—®é¢˜**: åœ¨å¤šå±‚ç¼“å­˜ï¼ˆæœ¬åœ° + Redisï¼‰åœºæ™¯ä¸‹ï¼Œ`delPattern()` åªåˆ é™¤æœ¬åœ°ç¼“å­˜ï¼Œä¸åˆ é™¤è¿œç«¯ Redis ç¼“å­˜ï¼Œå¯¼è‡´ç¼“å­˜å¤±æ•ˆä¸å®Œæ•´ã€‚

**ä¿®å¤**: 
- `MultiLevelCache.delPattern()` ç°åœ¨ä¼šåŒæ—¶åˆ é™¤æœ¬åœ°å’Œè¿œç«¯ç¼“å­˜
- ç¡®ä¿ `FunctionCache.invalidate()` åœ¨åŒå±‚ç¼“å­˜ä¸‹æ­£ç¡®å·¥ä½œ

**å½±å“èŒƒå›´**: 
- ä½¿ç”¨å¤šå±‚ç¼“å­˜çš„ç”¨æˆ·
- ä½¿ç”¨ç¼“å­˜å¤±æ•ˆåŠŸèƒ½çš„åœºæ™¯

---

## ğŸ“¦ å¯¼å‡ºæ›´æ–°

### CommonJS

```javascript
const MonSQLize = require('monsqlize');
const { withCache, FunctionCache } = require('monsqlize');
```

### ESM

```javascript
import MonSQLize, { withCache, FunctionCache } from 'monsqlize';
```

### TypeScript

```typescript
import { withCache, FunctionCache, WithCacheOptions, FunctionCacheOptions } from 'monsqlize';
```

---

## ğŸ“– æ–‡æ¡£

æ–°å¢ä»¥ä¸‹æ–‡æ¡£ï¼š

- `docs/function-cache.md` - å®Œæ•´ç”¨æˆ·æ–‡æ¡£
- `docs/function-cache-key-generation.md` - é”®ç”Ÿæˆæœºåˆ¶è¯¦è§£
- `docs/function-cache-implementation-plan.md` - å®æ–½æ–¹æ¡ˆ
- `docs/function-cache-final-plan.md` - ä¸‰è½®éªŒè¯æ–¹æ¡ˆ
- `docs/function-cache-invalidation-strategy.md` - ç¼“å­˜å¤±æ•ˆæ–¹æ¡ˆ
- `docs/FUNCTION-CACHE-FINAL-SUCCESS-REPORT.md` - å®ŒæˆæŠ¥å‘Š

---

## ğŸ§ª æµ‹è¯•

æ–°å¢æµ‹è¯•è¦†ç›–ï¼š

- **58ä¸ªæµ‹è¯•ç”¨ä¾‹**ï¼ˆ100% é€šè¿‡ï¼‰
  - 47ä¸ªæœ¬åœ°ç¼“å­˜æµ‹è¯•
  - 5ä¸ª Redis é›†æˆæµ‹è¯•
  - 6ä¸ªé›†åˆä¾èµ–æµ‹è¯• ğŸ†•
- å®Œæ•´çš„è¾¹ç•Œæ¡ä»¶æµ‹è¯•
- å®Œæ•´çš„é”™è¯¯åœºæ™¯æµ‹è¯•
- Redis é›†æˆå®Œæ•´éªŒè¯
- å¤šå±‚ç¼“å­˜å®Œæ•´éªŒè¯
- é›†åˆä¾èµ–è‡ªåŠ¨å¤±æ•ˆéªŒè¯ ğŸ†•

---

## ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: åŸºç¡€ç”¨æ³•

```javascript
const { withCache } = require('monsqlize');

// å¤æ‚ä¸šåŠ¡å‡½æ•°
async function getUserProfile(userId) {
    const user = await msq.collection('users').findOne({ _id: userId });
    const orders = await msq.collection('orders').find({ userId }).toArray();
    return { user, orders };
}

// æ·»åŠ ç¼“å­˜
const cachedGetUserProfile = withCache(getUserProfile, {
    ttl: 300000,
    cache: msq.getCache()
});

// ä½¿ç”¨
await cachedGetUserProfile('user123');  // é¦–æ¬¡ï¼šä»æ•°æ®åº“æŸ¥è¯¢
await cachedGetUserProfile('user123');  // å†æ¬¡ï¼šä»ç¼“å­˜è¯»å– âš¡
```

### ç¤ºä¾‹ 2: é›†åˆä¾èµ–è‡ªåŠ¨å¤±æ•ˆ ğŸ†•

```javascript
const { FunctionCache } = require('monsqlize');

const fnCache = new FunctionCache(msq);

// æ³¨å†Œæ—¶å£°æ˜ä¾èµ–
fnCache.register('getUserProfile', getUserProfileFn, {
    ttl: 300000,
    collections: ['users', 'orders']  // ğŸ†• å£°æ˜ä¾èµ–
});

// ä½¿ç”¨
await fnCache.execute('getUserProfile', 'user123');

// æ›´æ–°æ•°æ®
await msq.collection('users').updateOne({ _id: 'user123' }, { $set: { name: 'Alice' } });
// âœ… getUserProfile çš„ç¼“å­˜å·²è‡ªåŠ¨å¤±æ•ˆ

await fnCache.execute('getUserProfile', 'user123'); // é‡æ–°æŸ¥è¯¢
```

### ç¤ºä¾‹ 3: å¤šå‡½æ•°ä¾èµ–åŒä¸€é›†åˆ

```javascript
// å¤šä¸ªå‡½æ•°ä¾èµ– users é›†åˆ
fnCache.register('getUserProfile', fn1, { collections: ['users'] });
fnCache.register('getUserStats', fn2, { collections: ['users'] });

// æ›´æ–° users é›†åˆ
await msq.collection('users').updateOne(...);
// âœ… ä¸¤ä¸ªå‡½æ•°çš„ç¼“å­˜éƒ½è‡ªåŠ¨å¤±æ•ˆ
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### Redis é…ç½®

å¦‚æœä½¿ç”¨ Redis ç¼“å­˜ï¼Œè¯·ä½¿ç”¨ `127.0.0.1` è€Œä¸æ˜¯ `localhost`ï¼Œå¹¶ä½¿ç”¨ `db 0`ï¼š

```javascript
// âœ… æ¨è
MonSQLize.createRedisCacheAdapter('redis://127.0.0.1:6379/0')

// âŒ å¯èƒ½æœ‰é—®é¢˜ï¼ˆåœ¨æŸäº› Redis é…ç½®ä¸‹ï¼‰
MonSQLize.createRedisCacheAdapter('redis://localhost:6379/1')
```

### ç¼“å­˜é”®ç”Ÿæˆ

å‡½æ•°ç¼“å­˜ä¼šè‡ªåŠ¨åºåˆ—åŒ–å‚æ•°ç”Ÿæˆç¼“å­˜é”®ï¼š
- å¯¹è±¡é”®ä¼šè‡ªåŠ¨æ’åºï¼ˆç¡®ä¿ `{a:1, b:2}` å’Œ `{b:2, a:1}` ç”Ÿæˆç›¸åŒçš„é”®ï¼‰
- æ”¯æŒ Dateã€RegExpã€ObjectId ç­‰ç‰¹æ®Šç±»å‹
- `undefined` åºåˆ—åŒ–ä¸ºç©ºï¼Œ`null` åºåˆ—åŒ–ä¸º `null`

### é›†åˆä¾èµ–

- `collections` é€‰é¡¹æ˜¯å¯é€‰çš„
- ä¸æŒ‡å®šåˆ™ä¾èµ– TTL è‡ªç„¶è¿‡æœŸæˆ–æ‰‹åŠ¨å¤±æ•ˆ
- æ”¯æŒå£°æ˜å¤šä¸ªé›†åˆï¼š`collections: ['users', 'orders', 'products']`

---

## ğŸ”„ å‘åå…¼å®¹æ€§

- âœ… å®Œå…¨å‘åå…¼å®¹
- âœ… ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… å¯é€‰åŠŸèƒ½ï¼Œä¸ä½¿ç”¨ä¸ä¼šæœ‰ä»»ä½•å½±å“

---

## ğŸ“š ç›¸å…³é“¾æ¥

- [å‡½æ•°ç¼“å­˜å®Œæ•´æ–‡æ¡£](./docs/function-cache.md)
- [é”®ç”Ÿæˆæœºåˆ¶è¯¦è§£](./docs/function-cache-key-generation.md)
- [ç¼“å­˜å¤±æ•ˆæ–¹æ¡ˆ](./docs/function-cache-invalidation-strategy.md)

---

## ğŸ¯ å‡çº§å»ºè®®

### ä» v1.1.3 å‡çº§

```bash
npm install monsqlize@^1.1.4
```

æ— éœ€ä»£ç ä¿®æ”¹ï¼Œæ–°åŠŸèƒ½ä¸ºå¯é€‰å¢å¼ºã€‚

### å¼€å§‹ä½¿ç”¨å‡½æ•°ç¼“å­˜

```javascript
const { withCache } = require('monsqlize');

// ä¸ºä»»ä½•å¼‚æ­¥å‡½æ•°æ·»åŠ ç¼“å­˜
const cached = withCache(yourAsyncFunction, {
    ttl: 60000,
    cache: msq.getCache(),
    collections: ['your_collection']  // ğŸ†• è‡ªåŠ¨å¤±æ•ˆ
});
```

---

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ç¤¾åŒºçš„åé¦ˆå’Œå»ºè®®ï¼

---

**å‘å¸ƒæ—¶é—´**: 2026-02-09  
**ç‰ˆæœ¬å·**: v1.1.4  
**ç»´æŠ¤è€…**: monSQLize Team

