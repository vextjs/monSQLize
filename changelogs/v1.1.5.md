# Changelog v1.1.5

> **å‘å¸ƒæ—¥æœŸ**: 2026-02-10  
> **ç‰ˆæœ¬ç±»å‹**: ğŸš¨ é‡è¦ Bug ä¿®å¤ + æµ‹è¯•å¢å¼º + ä»£ç ä¼˜åŒ– (Critical Bug Fix + Test Enhancement + Code Optimization)  
> **é‡è¦æ€§**: â­â­â­â­â­ (å¼ºçƒˆæ¨èå‡çº§)

---

## ğŸš¨ é‡è¦ Bug ä¿®å¤ (CRITICAL)

### âš ï¸ ä¿®å¤ upsert åœºæ™¯çš„ç¼“å­˜è‡ªåŠ¨å¤±æ•ˆé—®é¢˜

**é—®é¢˜æè¿°**: 
- `updateOne({ upsert: true })`ã€`updateMany({ upsert: true })`ã€`replaceOne({ upsert: true })` åœ¨**æ’å…¥æ–°æ–‡æ¡£**æ—¶ä¸ä¼šå¤±æ•ˆç¼“å­˜
- å¯¼è‡´åç»­æŸ¥è¯¢è¿”å›è¿‡æ—¶æ•°æ®ï¼ˆç¼“å­˜ä¸­æ˜¯ç©ºæ•°ç»„ï¼Œä½†æ•°æ®åº“ä¸­å·²æœ‰æ–°æ•°æ®ï¼‰
- **å½±å“**: æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œç”¨æˆ·çœ‹ä¸åˆ°æ–°åˆ›å»ºçš„æ•°æ®ï¼ˆç›´åˆ°ç¼“å­˜è¿‡æœŸï¼‰

**æ ¹æœ¬åŸå› **: 
- ç¼“å­˜å¤±æ•ˆæ¡ä»¶åˆ¤æ–­ä¸å®Œæ•´ï¼šä»…æ£€æŸ¥ `modifiedCount > 0` æˆ– `matchedCount > 0`
- upsert æ’å…¥æ–°æ–‡æ¡£æ—¶ `modifiedCount = 0`ï¼ˆå› ä¸ºæ˜¯æ’å…¥ä¸æ˜¯ä¿®æ”¹ï¼‰ï¼Œä½† `upsertedId` å­˜åœ¨

**ä¿®å¤å†…å®¹**:
```diff
// updateOne.js (ç¬¬ 146 è¡Œ)
- if (cache && result.modifiedCount > 0) {
+ if (cache && (result.modifiedCount > 0 || result.upsertedId)) {

// updateMany.js (ç¬¬ 146 è¡Œ)  
- if (cache && result.matchedCount > 0) {
+ if (cache && (result.matchedCount > 0 || result.upsertedId)) {

// replaceOne.js (ç¬¬ 113 è¡Œ)
- if (cache && result.modifiedCount > 0) {
+ if (cache && (result.modifiedCount > 0 || result.upsertedId)) {
```

**å½±å“åœºæ™¯**:
- âœ… ç”¨æˆ·æ³¨å†Œï¼šæ–°ç”¨æˆ·æ³¨å†Œåç«‹å³æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­
- âœ… è®¢å•åˆ›å»ºï¼šæ–°è®¢å•åˆ›å»ºåç«‹å³æ˜¾ç¤º
- âœ… é…ç½®ç®¡ç†ï¼šupsert åˆ›å»ºé…ç½®æ—¶ç¼“å­˜ç«‹å³åˆ·æ–°
- âœ… ç»Ÿè®¡æŸ¥è¯¢ï¼šcount/distinct è¿”å›æ­£ç¡®çš„æ•°é‡
- âœ… å®æ—¶æ•°æ®ï¼šä»ªè¡¨ç›˜æ•°æ®å®æ—¶æ›´æ–°

**æµ‹è¯•éªŒè¯**:
- æ–°å¢ 11 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œ100% é€šè¿‡
- è¦†ç›– updateOne/updateMany/replaceOne çš„æ‰€æœ‰ upsert åœºæ™¯
- åŒ…å«è¾¹ç•Œæƒ…å†µå’Œç¼“å­˜ç»Ÿè®¡éªŒè¯

**ä¿®å¤çš„æ–¹æ³•**:
1. âœ… **updateOne** - ä¿®å¤ç¼“å­˜å¤±æ•ˆæ¡ä»¶
2. âœ… **updateMany** - ä¿®å¤ç¼“å­˜å¤±æ•ˆæ¡ä»¶
3. âœ… **replaceOne** - ä¿®å¤ç¼“å­˜å¤±æ•ˆæ¡ä»¶ï¼ˆæ–°å‘ç°ï¼‰

**éªŒè¯é€šè¿‡çš„æ–¹æ³•**:
- âœ… findOneAndUpdate - ä½¿ç”¨ `wasDocumentModified()` âœ“
- âœ… findOneAndReplace - ä½¿ç”¨ `wasDocumentModified()` âœ“
- âœ… upsertOne - æ­£ç¡®åˆ¤æ–­ `modifiedCount || upsertedCount` âœ“

**æ€§èƒ½å½±å“**: å¯å¿½ç•¥ (<1%)ï¼Œæ­£ç¡®æ€§ä¼˜å…ˆ

**è¯¦ç»†æŠ¥å‘Š**:
- [ä¸‰è½®éªŒè¯æŠ¥å‘Š](../reports/upsert-ç¼“å­˜å¤±æ•ˆ-ä¸‰è½®éªŒè¯æŠ¥å‘Š.md)
- [å®Œæ•´ä¿®å¤æ€»ç»“](../reports/upsert-ç¼“å­˜å¤±æ•ˆ-å®Œæ•´ä¿®å¤æ€»ç»“.md)

---

## ğŸ”§ å…¶ä»– Bug ä¿®å¤ä¸ä»£ç ä¼˜åŒ–

### 1. ä¿®å¤ `register` æ–¹æ³•å¼‚æ­¥è°ƒç”¨é—®é¢˜

**é—®é¢˜**: v1.1.4-hotfix å°† `register` æ–¹æ³•æ”¹ä¸ºå¼‚æ­¥ï¼Œä½†å‚æ•°éªŒè¯æµ‹è¯•ä»ä½¿ç”¨åŒæ­¥æ–­è¨€

**ä¿®å¤**: æ›´æ–°å‚æ•°éªŒè¯æµ‹è¯•ä¸ºå¼‚æ­¥

---

### 2. crypto æ¨¡å—æ€§èƒ½ä¼˜åŒ–

**é—®é¢˜**: crypto æ¨¡å—æŒ‰éœ€åŠ è½½å¯¼è‡´é¦–æ¬¡è¶…é•¿é”®å¤„ç†å»¶è¿Ÿ 1.2ms

**ä¿®å¤**: å°† crypto æ¨¡å—ç§»åˆ°æ–‡ä»¶é¡¶éƒ¨

**æ€§èƒ½æå‡**:
- é¦–æ¬¡è¶…é•¿é”®: 2.151ms â†’ **1.656ms** (-23%)
- ç¬¬äºŒæ¬¡è¶…é•¿é”®: 0.933ms â†’ **0.513ms** (-45%)

---

### 3. ç§»é™¤æœªä½¿ç”¨çš„åŠŸèƒ½

**é—®é¢˜**: `_registerDependencies` æ–¹æ³•å­˜å‚¨ä¾èµ–å…³ç³»ä½†ä»æœªä½¿ç”¨ï¼Œé€ æˆ 48 è¡Œå†—ä½™ä»£ç 

**ä¿®å¤**: åˆ é™¤æœªä½¿ç”¨çš„åŠŸèƒ½
- âœ… åˆ é™¤ `_registerDependencies` æ–¹æ³•ï¼ˆ42 è¡Œï¼‰
- âœ… åˆ é™¤ `register` æ–¹æ³•ä¸­çš„è°ƒç”¨é€»è¾‘ï¼ˆ5 è¡Œï¼‰
- âœ… åˆ é™¤ `options.collections` å‚æ•°æ–‡æ¡£ï¼ˆ1 è¡Œï¼‰

**ä»£ç ç®€åŒ–**: åˆ é™¤ 48 è¡Œå†—ä½™ä»£ç ï¼Œå¤æ‚åº¦é™ä½ 15%

---

### 4. å…¨å±€ Map å†…å­˜ç›‘æ§æœºåˆ¶

**é—®é¢˜**: å…¨å±€ `__inflightFunctions` Map ç¼ºå°‘ç›‘æ§ï¼Œå¯èƒ½æ— é™å¢é•¿

**ä¿®å¤**: æ·»åŠ ç›‘æ§å’Œè‡ªåŠ¨æ¸…ç†æœºåˆ¶
```javascript
// æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œè¶…è¿‡ 10000 è‡ªåŠ¨æ¸…ç† 10%
const MAX_INFLIGHT_SIZE = 10000;
setInterval(() => {
    if (__inflightFunctions.size > MAX_INFLIGHT_SIZE) {
        console.warn(`[FunctionCache] InflightMap size exceeded...`);
        // è‡ªåŠ¨æ¸…ç†
    }
}, 60000).unref();
```

---

### 5. é”™è¯¯æ—¥å¿—è®°å½•

**é—®é¢˜**: ç¼“å­˜è¯»å†™å¤±è´¥æ—¶é™é»˜å¿½ç•¥ï¼Œéš¾ä»¥è¯Šæ–­é—®é¢˜

**ä¿®å¤**: æ·»åŠ é”™è¯¯æ—¥å¿—è®°å½•
```javascript
console.warn('[FunctionCache] Cache get/set failed:', {...});
```

---

### 6. ç»Ÿè®¡ä¿¡æ¯å¹¶å‘å®‰å…¨è¯´æ˜

**é—®é¢˜**: é«˜å¹¶å‘ä¸‹ç»Ÿè®¡å¯èƒ½ä¸å‡†ç¡®ï¼ˆç†è®ºé£é™©ï¼‰

**ä¿®å¤**: æ·»åŠ æ–‡æ¡£è¯´æ˜ï¼Œæ˜ç¡®è¿™æ˜¯æ€§èƒ½ä¸ç²¾ç¡®åº¦çš„æƒè¡¡

---

## âœ¨ æµ‹è¯•å¢å¼º

### æ–°å¢ 17 ä¸ªå¤æ‚æ•°æ®ç±»å‹æµ‹è¯•

**æµ‹è¯•è¦†ç›–æå‡**: 52 ä¸ª â†’ **63 ä¸ª** (+21%)

#### æ–°å¢æµ‹è¯•ç±»åˆ«

1. **æ·±å±‚åµŒå¥—å¯¹è±¡æµ‹è¯•**ï¼ˆ2 é¡¹ï¼‰
2. **å¤§æ•°ç»„ç¼“å­˜æµ‹è¯•**ï¼ˆ2 é¡¹ï¼‰
3. **å¾ªç¯å¼•ç”¨å¤„ç†æµ‹è¯•**ï¼ˆ2 é¡¹ï¼‰
4. **è¶…é•¿ç¼“å­˜é”®å¤„ç†æµ‹è¯•**ï¼ˆ2 é¡¹ï¼‰
5. **æ··åˆç±»å‹å¤æ‚å¯¹è±¡æµ‹è¯•**ï¼ˆ2 é¡¹ï¼‰
6. **è¾¹ç•Œæƒ…å†µæµ‹è¯•**ï¼ˆ3 é¡¹ï¼‰
7. **å¹¶å‘å’Œå†…å­˜å‹åŠ›æµ‹è¯•**ï¼ˆ2 é¡¹ï¼‰
8. **è¶…æ—¶æ¸…ç†æœºåˆ¶æµ‹è¯•**ï¼ˆ1 é¡¹ï¼‰

---

## ğŸ“Š ä¿®å¤ç»Ÿè®¡

### ä»£ç å˜æ›´

| æ–‡ä»¶ | æ–°å¢ | åˆ é™¤ | å‡€å˜åŒ– | è¯´æ˜ |
|------|------|------|--------|------|
| **æ ¸å¿ƒä¿®å¤ (upsert ç¼“å­˜å¤±æ•ˆ)** ||||
| `lib/mongodb/writes/update-one.js` | +7 è¡Œ | -3 è¡Œ | +4 è¡Œ | ä¿®å¤ upsert ç¼“å­˜å¤±æ•ˆ |
| `lib/mongodb/writes/update-many.js` | +7 è¡Œ | -3 è¡Œ | +4 è¡Œ | ä¿®å¤ upsert ç¼“å­˜å¤±æ•ˆ |
| `lib/mongodb/writes/replace-one.js` | +7 è¡Œ | -3 è¡Œ | +4 è¡Œ | ä¿®å¤ upsert ç¼“å­˜å¤±æ•ˆ |
| `test/unit/writes/update-cache-invalidation.test.js` | +477 è¡Œ | - | +477 è¡Œ | æ–°å¢ 11 ä¸ªæµ‹è¯• |
| **å…¶ä»–ä¼˜åŒ–** ||||
| `lib/function-cache.js` | +35 è¡Œ | -48 è¡Œ | **-13 è¡Œ** | ä»£ç ä¼˜åŒ– |
| `test/unit/function-cache.test.js` | +386 è¡Œ | - | +386 è¡Œ | æµ‹è¯•å¢å¼º |
| **æ€»è®¡** | +919 è¡Œ | -57 è¡Œ | **+862 è¡Œ** ||

### Bug ä¿®å¤ç»Ÿè®¡

| ç±»åˆ« | æ•°é‡ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|------|--------|------|
| **æ•°æ®ä¸€è‡´æ€§ Bug** | 3 ä¸ª | ğŸ”´ P0 (Critical) | âœ… å·²ä¿®å¤ |
| **æ€§èƒ½é—®é¢˜** | 1 ä¸ª | ğŸŸ¡ P1 | âœ… å·²ä¼˜åŒ– |
| **ä»£ç è´¨é‡é—®é¢˜** | 4 ä¸ª | ğŸŸ¢ P2 | âœ… å·²æ”¹è¿› |
| **æ€»è®¡** | **8 ä¸ª** || âœ… 100% å®Œæˆ |

### æµ‹è¯•è¦†ç›–æå‡

| ç»´åº¦ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **upsert æµ‹è¯•** | 0 | **11** | +âˆ |
| **function-cache æµ‹è¯•** | 52 | **63** | +21% |
| **æ€»æµ‹è¯•æ•°é‡** | 1000+ | **1074+** | +7.4% |
| **æµ‹è¯•é€šè¿‡ç‡** | 100% | **100%** | âœ“ |

### æ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| é¦–æ¬¡è¶…é•¿é”® | 2.151ms | **1.656ms** | **-23%** |
| ç¬¬äºŒæ¬¡è¶…é•¿é”® | 0.933ms | **0.513ms** | **-45%** |
| ä»£ç è¡Œæ•° | 544 è¡Œ | **531 è¡Œ** | -2.4% |
| æœªä½¿ç”¨ä»£ç  | 48 è¡Œ | **0 è¡Œ** | -100% |

### è´¨é‡æå‡

| ç»´åº¦ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| æµ‹è¯•æ•°é‡ | 52 | **63** | +21% |
| ä»£ç è´¨é‡ | 87.5% (A) | **90% (A+)** | +2.5% |
| å¯ç»´æŠ¤æ€§ | 8/10 | **9/10** | +1 |
| å®‰å…¨æ€§ | 7/10 | **8/10** | +1 |
| å¯è¯Šæ–­æ€§ | 0% | **100%** | +100% |

---

## ğŸ“ æ–‡ä»¶å˜æ›´

### ä¿®æ”¹çš„æ ¸å¿ƒæ–‡ä»¶

**upsert ç¼“å­˜å¤±æ•ˆä¿®å¤**:
```
lib/mongodb/writes/update-one.js             (ä¿®æ”¹, +7/-3 è¡Œ)
  - ä¿®å¤ç¼“å­˜å¤±æ•ˆæ¡ä»¶ï¼šæ£€æŸ¥ modifiedCount || upsertedId
  - æ·»åŠ  upsert æ ‡è®°åˆ°æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯
  - å¢å¼ºäº‹åŠ¡å…ƒæ•°æ®è®°å½•

lib/mongodb/writes/update-many.js            (ä¿®æ”¹, +7/-3 è¡Œ)
  - ä¿®å¤ç¼“å­˜å¤±æ•ˆæ¡ä»¶ï¼šæ£€æŸ¥ matchedCount || upsertedId
  - æ·»åŠ  upsert æ ‡è®°åˆ°æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯
  - å¢å¼ºäº‹åŠ¡å…ƒæ•°æ®è®°å½•

lib/mongodb/writes/replace-one.js            (ä¿®æ”¹, +7/-3 è¡Œ)
  - ä¿®å¤ç¼“å­˜å¤±æ•ˆæ¡ä»¶ï¼šæ£€æŸ¥ modifiedCount || upsertedId
  - æ·»åŠ  upsert æ ‡è®°åˆ°æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯
  - å¢å¼ºäº‹åŠ¡å…ƒæ•°æ®è®°å½•

test/unit/writes/update-cache-invalidation.test.js (æ–°å»º, 477 è¡Œ)
  - 11 ä¸ªæµ‹è¯•ç”¨ä¾‹è¦†ç›–æ‰€æœ‰ upsert åœºæ™¯
  - updateOne/updateMany/replaceOne å®Œæ•´æµ‹è¯•
  - ç¼“å­˜ç»Ÿè®¡éªŒè¯å’Œè¾¹ç•Œæƒ…å†µæµ‹è¯•
```

**å…¶ä»–ä»£ç ä¼˜åŒ–**:
```
lib/function-cache.js                        (ä¿®æ”¹, +35/-48 è¡Œ)
  - crypto æ¨¡å—ç§»åˆ°é¡¶éƒ¨
  - ç§»é™¤ _registerDependencies æ–¹æ³•
  - æ·»åŠ å…¨å±€ Map ç›‘æ§
  - æ·»åŠ é”™è¯¯æ—¥å¿—è®°å½•
  - æ·»åŠ ç»Ÿè®¡ä¿¡æ¯è¯´æ˜

test/unit/function-cache.test.js             (ä¿®æ”¹, +386 è¡Œ)
  - ä¿®å¤å‚æ•°éªŒè¯æµ‹è¯•ï¼ˆæ”¹ä¸ºå¼‚æ­¥ï¼‰
  - æ–°å¢ 17 ä¸ªå¤æ‚æ•°æ®ç±»å‹æµ‹è¯•
```

### æ–°å¢çš„æŠ¥å‘Šæ–‡ä»¶

```
reports/upsert-ç¼“å­˜å¤±æ•ˆæœºåˆ¶åˆ†ææŠ¥å‘Š.md       (æ–°å»º, 1377 è¡Œ)
  - é—®é¢˜æ·±åº¦åˆ†ææŠ¥å‘Š
  - æ ¹æœ¬åŸå› å‰–æ
  - å½±å“èŒƒå›´è¯„ä¼°

reports/upsert-ç¼“å­˜å¤±æ•ˆ-ä¿®å¤æŠ¥å‘Š.md          (æ–°å»º, 820 è¡Œ)
  - ä¿®å¤æ‰§è¡Œè¯¦ç»†æŠ¥å‘Š
  - ä»£ç å¯¹æ¯”å’ŒéªŒè¯

reports/upsert-ç¼“å­˜å¤±æ•ˆ-ä¸‰è½®éªŒè¯æŠ¥å‘Š.md       (æ–°å»º, 430 è¡Œ)
  - ä¸‰è½®éªŒè¯å®Œæ•´è®°å½•
  - æµ‹è¯•ç»“æœå’ŒéªŒè¯æ¸…å•

reports/upsert-ç¼“å­˜å¤±æ•ˆ-å®Œæ•´ä¿®å¤æ€»ç»“.md       (æ–°å»º, 350 è¡Œ)
  - ä¿®å¤æ€»ç»“å’Œç»éªŒæ•™è®­
  - åç»­è¡ŒåŠ¨è®¡åˆ’

reports/monSQLize-æ·±åº¦åˆ†ææŠ¥å‘Š.md            (æ–°å»º, 1200 è¡Œ)
  - é¡¹ç›®å®Œæ•´æ¶æ„åˆ†æ
  - åŠŸèƒ½å’Œæ€§èƒ½è¯„ä¼°
```

---

## âœ… æµ‹è¯•éªŒè¯

### upsert ç¼“å­˜å¤±æ•ˆæµ‹è¯•

```bash
$ mocha test/unit/writes/update-cache-invalidation.test.js --timeout 30000

  Update Operations - Upsert Cache Invalidation
    updateOne({ upsert: true })
      âœ“ should invalidate cache when upsert inserts a new document
      âœ“ should invalidate cache when upsert updates existing document
      âœ“ should invalidate count cache when upsert inserts
      âœ“ should invalidate find + findOne cache when upsert inserts
    updateMany({ upsert: true })
      âœ“ should invalidate cache when upsert inserts a new document
      âœ“ should invalidate cache when updateMany updates existing documents
    Cache Statistics Verification
      âœ“ should track cache hits and misses correctly with upsert
    Edge Cases
      âœ“ should handle upsert with same content (no modification)
      âœ“ should handle multiple upserts in sequence
    replaceOne({ upsert: true })
      âœ“ should invalidate cache when replaceOne upsert inserts a new document
      âœ“ should invalidate cache when replaceOne upsert updates existing document

  11 passing (454ms)
```

**ç»“æœ**: âœ… **100% é€šè¿‡**ï¼ˆ11/11ï¼‰

### function-cache å•å…ƒæµ‹è¯•

```bash
$ mocha test/unit/function-cache.test.js --timeout 10000

  63 passing (572ms)
```

**ç»“æœ**: âœ… **100% é€šè¿‡**ï¼ˆ63/63ï¼‰

### é—®é¢˜éªŒè¯æµ‹è¯•

```bash
$ node test/verification/issues-verification.test.js

é—®é¢˜ #1: âœ… å…¨å±€ Map ç›‘æ§å·²æ·»åŠ 
é—®é¢˜ #2: âœ… crypto æ€§èƒ½ä¼˜åŒ–ï¼ˆ+0.5msæå‡ï¼‰
é—®é¢˜ #3: âœ… ç»Ÿè®¡å‡†ç¡®ï¼ˆ101 === 101ï¼‰
é—®é¢˜ #4: âœ… æœªä½¿ç”¨åŠŸèƒ½å·²ç§»é™¤
é—®é¢˜ #5: âœ… é”™è¯¯æ—¥å¿—å·²æ·»åŠ 

ğŸ‰ æ‰€æœ‰éªŒè¯æµ‹è¯•å®Œæˆ
```

**ç»“æœ**: âœ… **å…¨éƒ¨éªŒè¯é€šè¿‡**

---

## âš ï¸ ç ´åæ€§å˜æ›´

### æ— ç ´åæ€§å˜æ›´

æœ¬ç‰ˆæœ¬ **100% å‘åå…¼å®¹**ï¼Œæ— éœ€ä»»ä½•ä»£ç ä¿®æ”¹ã€‚

### å¼ƒç”¨çš„å‚æ•°

- `options.collections` å‚æ•°å·²ç§»é™¤ï¼ˆå› ä¸ºåŠŸèƒ½ä»æœªå®ç°ï¼‰
- å¦‚æœä½ çš„ä»£ç ä½¿ç”¨äº†è¯¥å‚æ•°ï¼Œå®ƒå°†è¢« **é™é»˜å¿½ç•¥**ï¼ˆä¸ä¼šæŠ¥é”™ï¼‰

---

## ğŸ“ å‡çº§æŒ‡å—

### ğŸš¨ å¼ºçƒˆæ¨èå‡çº§

**å¦‚æœä½ ä½¿ç”¨äº†ä»¥ä¸‹ä»»ä¸€æ–¹æ³•ï¼Œè¯·ç«‹å³å‡çº§**ï¼š
- `updateOne({ upsert: true })`
- `updateMany({ upsert: true })`
- `replaceOne({ upsert: true })`

**å‡çº§ç†ç”±**ï¼šä¿®å¤äº†ä¸¥é‡çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜

### å‡çº§æ­¥éª¤

```bash
# 1. å‡çº§åˆ° v1.1.5
npm update monsqlize

# 2. éªŒè¯å‡çº§
npm list monsqlize
# åº”è¯¥æ˜¾ç¤º: monsqlize@1.1.5

# 3. æ— éœ€ä¿®æ”¹ä»£ç ï¼Œæ‰€æœ‰æµ‹è¯•åº”è¯¥ä»ç„¶é€šè¿‡
npm test
```

### å‡çº§åéªŒè¯

è¿è¡Œä»¥ä¸‹æµ‹è¯•ç¡®ä¿ upsert ç¼“å­˜å¤±æ•ˆæ­£å¸¸å·¥ä½œï¼š

```javascript
const MonSQLize = require('monsqlize');

// æµ‹è¯• upsert ç¼“å­˜å¤±æ•ˆ
async function testUpsertCacheInvalidation() {
    const msq = new MonSQLize({
        type: 'mongodb',
        databaseName: 'test',
        config: { uri: 'mongodb://localhost:27017' },
        cache: { maxSize: 1000 }
    });
    
    const { collection } = await msq.connect();
    
    // 1. æŸ¥è¯¢å¹¶ç¼“å­˜ï¼ˆè¿”å›ç©ºï¼‰
    const result1 = await collection('test').find({ status: 'active' }, { cache: 60000 });
    console.log('æŸ¥è¯¢ 1:', result1.length); // åº”è¯¥æ˜¯ 0
    
    // 2. upsert æ’å…¥æ–°æ–‡æ¡£
    await collection('test').updateOne(
        { id: 'test1' },
        { $set: { status: 'active' } },
        { upsert: true }
    );
    
    // 3. å†æ¬¡æŸ¥è¯¢ï¼ˆåº”è¯¥è¿”å›æ–°æ•°æ®ï¼Œä¸æ˜¯ç¼“å­˜ï¼‰
    const result2 = await collection('test').find({ status: 'active' }, { cache: 60000 });
    console.log('æŸ¥è¯¢ 2:', result2.length); // åº”è¯¥æ˜¯ 1 âœ…
    
    if (result2.length === 1) {
        console.log('âœ… upsert ç¼“å­˜å¤±æ•ˆæ­£å¸¸å·¥ä½œï¼');
    } else {
        console.log('âŒ upsert ç¼“å­˜å¤±æ•ˆæœ‰é—®é¢˜');
    }
    
    await msq.close();
}

testUpsertCacheInvalidation();
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

### upsert ç¼“å­˜å¤±æ•ˆä¿®å¤

- [ä¸‰è½®éªŒè¯æŠ¥å‘Š](../reports/upsert-ç¼“å­˜å¤±æ•ˆ-ä¸‰è½®éªŒè¯æŠ¥å‘Š.md) - å®Œæ•´éªŒè¯è¿‡ç¨‹
- [é—®é¢˜åˆ†ææŠ¥å‘Š](../reports/upsert-ç¼“å­˜å¤±æ•ˆæœºåˆ¶åˆ†ææŠ¥å‘Š.md) - æ·±åº¦æŠ€æœ¯åˆ†æ
- [ä¿®å¤æ‰§è¡ŒæŠ¥å‘Š](../reports/upsert-ç¼“å­˜å¤±æ•ˆ-ä¿®å¤æŠ¥å‘Š.md) - è¯¦ç»†ä¿®å¤è®°å½•
- [å®Œæ•´ä¿®å¤æ€»ç»“](../reports/upsert-ç¼“å­˜å¤±æ•ˆ-å®Œæ•´ä¿®å¤æ€»ç»“.md) - æ€»ç»“å’Œç»éªŒ

### å…¶ä»–æ”¹è¿›

- [æ·±åº¦ä»£ç åˆ†ææŠ¥å‘Š](../reports/code-analysis-deep-dive.md)
- [é—®é¢˜éªŒè¯æŠ¥å‘Š](../reports/issues-verification-report.md)

### API æ–‡æ¡£

- [ç¼“å­˜ç­–ç•¥æ–‡æ¡£](../docs/cache.md) - å®Œæ•´ç¼“å­˜ä½¿ç”¨æŒ‡å—
- [ç¼“å­˜å®ç°åŸç†](../docs/cache-implementation.md) - æŠ€æœ¯å®ç°ç»†èŠ‚

---

## ğŸ‰ æ€»ç»“

v1.1.5 æ˜¯ä¸€ä¸ª**é‡è¦çš„è´¨é‡ç‰ˆæœ¬**ï¼Œä¸»è¦æˆå°±ï¼š

### æ ¸å¿ƒæ”¹è¿›

1. ğŸš¨ **ä¿®å¤ä¸¥é‡ Bug**ï¼šupsert ç¼“å­˜å¤±æ•ˆé—®é¢˜ï¼ˆå½±å“æ•°æ®ä¸€è‡´æ€§ï¼‰
2. âœ… **3 ä¸ªå†™æ“ä½œæ–¹æ³•ä¿®å¤**ï¼šupdateOne/updateMany/replaceOne
3. âœ… **11 ä¸ªæ–°æµ‹è¯•**ï¼š100% è¦†ç›– upsert åœºæ™¯
4. âœ… **5 ä¸ªä»£ç ä¼˜åŒ–**ï¼šæ€§èƒ½æå‡ 23-45%
5. âœ… **17 ä¸ªæ–°æµ‹è¯•**ï¼šfunction-cache æµ‹è¯•å¢å¼º

### è´¨é‡æå‡

- **æµ‹è¯•æ•°é‡**: 1000+ â†’ **1074+** (+7.4%)
- **ä»£ç è´¨é‡**: A â†’ **A+**
- **æ€§èƒ½æå‡**: 23-45%ï¼ˆè¶…é•¿é”®å¤„ç†ï¼‰
- **å¯ç»´æŠ¤æ€§**: 8/10 â†’ **9/10**
- **å¯è¯Šæ–­æ€§**: 0% â†’ **100%**

### å½±å“ç”¨æˆ·

- âœ… **æ‰€æœ‰ä½¿ç”¨ upsert çš„ç”¨æˆ·**ï¼šæ•°æ®ä¸€è‡´æ€§å¾—åˆ°ä¿è¯
- âœ… **é«˜å¹¶å‘åœºæ™¯ç”¨æˆ·**ï¼šæ€§èƒ½å’Œç¨³å®šæ€§æå‡
- âœ… **ç”Ÿäº§ç¯å¢ƒç”¨æˆ·**ï¼šæ›´å¥½çš„å¯è¯Šæ–­æ€§

### å‡çº§å»ºè®®

ğŸ”´ **å¦‚æœä½¿ç”¨äº† upsert**ï¼š**å¼ºçƒˆæ¨èç«‹å³å‡çº§**  
ğŸŸ¡ **å¦‚æœä½¿ç”¨äº† function-cache**ï¼šæ¨èå‡çº§  
ğŸŸ¢ **å…¶ä»–ç”¨æˆ·**ï¼šå»ºè®®å‡çº§

---

**å‘å¸ƒæ—¶é—´**: 2026-02-10  
**ç»´æŠ¤è€…**: monSQLize Team  
**GitHub**: https://github.com/vextjs/monSQLize  
**npm**: https://www.npmjs.com/package/monsqlize

