# v1.1.0 详细变更文档

---

## 📋 版本信息

| 项目 | 内容 |
|------|------|
| **版本号** | v1.1.0 |
| **发布日期** | 2025-12-03 |
| **变更类型** | 新功能 |
| **风险级别** | P2 (Low) |
| **向后兼容** | ✅ 完全兼容 |

---

## 📝 变更摘要

新增 MongoDB Change Streams 实时监听功能（watch方法），支持自动重连、智能缓存失效和完整的事件系统。

---

## 🎯 背景说明

### 为什么需要这次变更？

MongoDB Change Streams 是实时数据同步和事件驱动架构的核心能力。monSQLize 作为企业级 ORM，需要提供开箱即用的 Change Streams 支持，让用户能够：

1. 实时监听数据库变更
2. 构建事件驱动应用
3. 实现多实例间的缓存同步
4. 支持分布式系统的数据一致性

### 现状问题

- 用户需要直接操作 MongoDB Native Driver 的 Change Streams API
- 缺少自动重连和错误处理机制
- 缺少与 monSQLize 缓存系统的集成
- 缺少生产环境所需的监控和统计功能

### 目标

- ✅ 提供简洁易用的 watch() API
- ✅ 自动处理连接中断和重连
- ✅ 与缓存系统深度集成
- ✅ 提供完整的事件系统和统计监控

---

## 📦 变更内容

### 核心功能

#### 1. watch() 方法 - MongoDB Change Streams 实时监听

提供 `watch()` 方法，支持监听集合或数据库级别的数据变更：

```javascript
// 监听集合变更
const watcher = db.collection('users').watch();
watcher.on('change', (change) => {
  console.log('数据变更:', change);
});

// 使用聚合管道过滤
const watcher = db.collection('orders').watch([
  { $match: { 'fullDocument.status': 'paid' } }
]);
```

#### 2. 自动重连机制

- 网络中断后自动重连（指数退避算法）
- 重连间隔：1s → 2s → 4s → 8s → ... → 60s（最大）
- resumeToken 自动管理和断点续传
- 智能错误分类（瞬态/持久性/致命）

#### 3. 智能缓存失效

- 监听到数据变更时自动失效相关缓存
- 支持精准失效（根据 operationType 和 documentKey）
- 自动触发跨实例缓存同步（复用 DistributedCacheInvalidator）

#### 4. 完整的事件系统

支持 6 种事件类型：
- `change` - 数据变更事件
- `error` - 错误事件
- `reconnect` - 重连成功事件
- `resume` - 断点续传事件
- `close` - 连接关闭事件
- `fatal` - 致命错误事件（无法重连）

#### 5. 统计监控

提供 `getStats()` 方法获取运行统计：
- 总变更数
- 重连次数
- 缓存失效次数
- 错误统计

#### 6. 副本集支持

- mongodb-memory-server 副本集模式配置
- 测试环境完整支持 Change Streams
- 自动检测副本集可用性

### 技术实现

- **核心文件**: `lib/mongodb/watch.js`
- **事件管理**: 基于 Node.js EventEmitter
- **重连策略**: 指数退避算法（exponential backoff）
- **错误分类**: 瞬态错误自动重试，致命错误停止监听
- **缓存集成**: 无缝集成现有缓存失效机制

---

## 📊 影响范围

### 新增的文件

- `lib/mongodb/watch.js` - watch 方法实现
- `docs/watch.md` - API 文档（400 行）
- `examples/watch.examples.js` - 使用示例（6 个场景）
- `test/unit/features/watch.test.js` - 单元测试（17 个用例）
- `test/integration/watch.integration.test.js` - 集成测试（7 个用例）

### 更新的文件

- `lib/mongodb/index.js` - 集成 watch 方法
- `docs/events.md` - 更新事件文档
- `docs/INDEX.md` - 更新文档索引
- `README.md` - 更新功能列表

### 用户影响

- ✅ 纯新增功能，不影响现有代码
- ✅ 完全向后兼容
- ✅ 可选功能，不使用不会有任何影响
- ✅ 无需修改配置或代码

---

## 📋 详细变更清单

### ✨ Added（新增）

#### 核心功能
- ✨ **watch() 方法** - MongoDB Change Streams 实时监听
  - 监听集合/数据库的数据变更（insert/update/delete/replace）
  - 支持聚合管道过滤事件
  - 完整的事件系统（change, error, reconnect, resume, close, fatal）

- 🔄 **自动重连机制**
  - 网络中断后自动重连（指数退避算法：1s → 2s → 4s → 8s → ... → 60s）
  - resumeToken 自动管理和断点续传
  - 智能错误分类（瞬态/持久性/致命）

- 🗑️ **智能缓存失效**
  - 监听到数据变更时自动失效相关缓存
  - 支持精准失效（根据 operationType 和 documentKey）
  - 自动触发跨实例缓存同步（复用 DistributedCacheInvalidator）

- 📊 **统计监控**
  - getStats() 方法获取运行统计
  - 监控总变更数、重连次数、缓存失效次数等

- 🧪 **副本集支持**
  - mongodb-memory-server 副本集模式配置
  - 测试环境完整支持 Change Streams

#### 文档
- 📄 新增 `docs/watch.md` - 完整 API 文档（400 行）
- 📝 新增 `examples/watch.examples.js` - 6 个使用示例
- 🔗 更新 `docs/events.md` 和 `docs/INDEX.md` - 交叉引用

#### 测试
- ✅ 新增 17 个单元测试（100% 通过）
- ✅ 新增 7 个集成测试（100% 通过，副本集环境）
- ✅ 测试覆盖率约 85%

---

## ✅ 验证方法

### 单元测试

```bash
npm test -- test/unit/features/watch.test.js
```

验证内容：
- watch 方法基本功能
- 事件系统完整性
- 重连机制
- 缓存失效逻辑
- 错误处理

### 集成测试

```bash
npm run test:integration -- test/integration/watch.integration.test.js
```

验证内容：
- 真实 MongoDB 副本集环境
- 实际数据变更监听
- 跨实例缓存同步
- 长时间运行稳定性

### 手动验证步骤

1. 启动 MongoDB 副本集
2. 运行示例代码 `examples/watch.examples.js`
3. 观察实时变更监听
4. 模拟网络中断，验证自动重连
5. 检查缓存失效是否生效

### 验证结果

- ✅ 所有单元测试通过（17/17）
- ✅ 所有集成测试通过（7/7）
- ✅ 测试覆盖率 85%+
- ✅ 副本集环境验证通过
- ✅ 重连机制稳定性验证通过

---

## 📚 使用示例

### 基础用法

```javascript
const { MongoDBClient } = require('monSQLize');
const db = new MongoDBClient({ uri: 'mongodb://localhost:27017' });

// 监听集合变更
const watcher = db.collection('users').watch();

watcher.on('change', (change) => {
  console.log('操作类型:', change.operationType);
  console.log('文档ID:', change.documentKey._id);
  if (change.fullDocument) {
    console.log('完整文档:', change.fullDocument);
  }
});

watcher.on('error', (error) => {
  console.error('监听错误:', error);
});

watcher.on('reconnect', () => {
  console.log('重连成功');
});
```

### 使用过滤管道

```javascript
// 只监听已支付的订单
const watcher = db.collection('orders').watch([
  { $match: { 'fullDocument.status': 'paid' } }
]);

watcher.on('change', (change) => {
  console.log('新订单已支付:', change.fullDocument);
  // 触发后续业务逻辑（发货、通知等）
});
```

### 启用自动缓存失效

```javascript
const watcher = db.collection('users').watch({
  autoCacheInvalidation: true // 自动失效缓存
});

// 当数据库中的用户数据变更时，相关缓存会自动失效
```

---

## 🔗 相关资源

- **文档**: 
  - [watch 方法完整文档](../docs/watch.md)
  - [事件系统文档](../docs/events.md)
- **示例**: 
  - [watch 使用示例](../examples/watch.examples.js)
- **测试**: 
  - [单元测试](../test/unit/features/watch.test.js)
  - [集成测试](../test/integration/watch.integration.test.js)

---

## 💭 设计决策

### 为什么使用指数退避算法？

指数退避能够：
1. 快速恢复短暂的网络抖动（1s 重试）
2. 避免对故障服务造成额外压力（逐步延长间隔）
3. 设置合理的上限（60s）防止无限等待

### 为什么集成缓存失效？

Change Streams 天然适合用于缓存失效：
1. 实时性：变更发生时立即失效缓存
2. 精准性：可以根据文档 ID 精准失效
3. 分布式：自动同步到所有实例

### 为什么支持副本集模式测试？

因为 Change Streams 只在副本集上可用，测试环境必须模拟真实场景。

---

## 🔮 未来改进

- [ ] 支持 Change Streams 预过滤（MongoDB 6.0+）
- [ ] 支持批量变更处理（提高吞吐量）
- [ ] 支持变更事件持久化（用于审计）
- [ ] 支持自定义重连策略

---

**文档生成时间**: 2025-12-03  
**文档版本**: 1.0

