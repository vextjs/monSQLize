# v1.0.9 变更日志

> **发布日期**: 2026-01-17  
> **版本类型**: 🎉 新功能 - Change Stream 数据同步  

---

## 🎉 新功能

### Change Stream 数据同步

**实时同步数据到备份库，基于 MongoDB Change Stream 原生机制**

#### 核心特性

- ✅ **实时同步**：延迟 10-500ms，基于 MongoDB Change Stream
- ✅ **断点续传**：Resume Token 自动保存，重启后继续
- ✅ **多目标支持**：同时同步到多个备份库
- ✅ **数据过滤**：自定义过滤逻辑
- ✅ **数据转换**：支持脱敏、字段转换
- ✅ **自动重连**：网络中断自动恢复（最多5次）
- ✅ **健康检查**：复用 ConnectionPoolManager
- ✅ **主库影响小**：<2%，异步处理

#### 使用示例

```javascript
const MonSQLize = require('monsqlize');

const msq = new MonSQLize({
    type: 'mongodb',
    config: {
        uri: 'mongodb://localhost:27017/main',
        replicaSet: 'rs0'  // 🔴 必须
    },
    
    // 🆕 同步配置
    sync: {
        enabled: true,
        targets: [
            {
                name: 'backup-main',
                uri: 'mongodb://backup:27017/backup',
                collections: ['users', 'orders']
            }
        ],
        resumeToken: {
            storage: 'file',  // 'file' | 'redis'
            path: './.sync-resume-token'
        }
    }
});

await msq.connect();

// 正常使用，自动同步
await msq.collection('users').insertOne({ name: 'Alice' });
// ✅ 自动同步到 backup-main
```

#### 新增文件

| 文件 | 行数 | 说明 |
|------|------|------|
| `lib/sync/ChangeStreamSyncManager.js` | 280 | Change Stream 管理器（核心） |
| `lib/sync/SyncTarget.js` | 120 | 备份目标（复用连接池） |
| `lib/sync/ResumeTokenStore.js` | 80 | Resume Token 持久化 |
| `lib/sync/SyncConfig.js` | 50 | 配置验证 |
| `lib/sync/index.js` | 10 | 模块导出 |

#### 修改文件

| 文件 | 变更 | 说明 |
|------|------|------|
| `lib/index.js` | +80行 | 集成 ChangeStreamSyncManager |

#### 新增文档

- `docs/sync-backup.md`: 完整使用指南
- `examples/sync-backup.examples.js`: 6个示例

---

## ⚠️ 前提条件

使用 Change Stream 同步需要满足：

1. **MongoDB Replica Set** 🔴
   ```bash
   rs.status()  # 检查
   rs.initiate()  # 初始化（单节点转 Replica Set）
   ```

2. **MongoDB 版本 >= 4.0** 🔴

3. **用户权限** 🔴
   - 需要 `changeStream` 权限

---

## 📊 性能影响

| 写入 QPS | 主库 CPU | 主库内存 | 同步延迟 |
|---------|---------|---------|---------|
| 100 | +0.5% | +10MB | 10-50ms |
| 1000 | +1% | +20MB | 50-200ms |
| 5000 | +2% | +50MB | 200-500ms |

---

## 🔧 API

### 构造函数选项

```javascript
{
    sync: {
        enabled: boolean,        // 是否启用
        targets: Array,          // 备份目标
        resumeToken: Object,     // Resume Token 配置
        filter: Function,        // 过滤函数（可选）
        transform: Function      // 转换函数（可选）
    }
}
```

### 实例方法

```javascript
// 获取统计
msq._syncManager.getStats()

// 手动停止
await msq._syncManager.stop()

// 手动启动
await msq._syncManager.start()
```

---

## 📚 完整文档

- [使用指南](../docs/sync-backup.md)
- [示例代码](../examples/sync-backup.examples.js)
- [方案设计](../plans/requirements/req-sync-changestream-final-v1.0.9.md)
- [验证报告](../reports/monSQLize/verification/sync-changestream-verification-v1.0.9.md)

---

## 🎯 应用场景

1. **多地容灾**: 同步到多个地域的备份库
2. **数据备份**: 实时备份到专用备份库
3. **数据仓库**: 同步到分析库（ETL）
4. **跨集群同步**: 同步到其他 MongoDB 集群

---

## ⚡ 性能优化建议

1. **过滤不必要的集合**
   ```javascript
   collections: ['users', 'orders']  // 不要用 ['*']
   ```

2. **使用 Redis 存储 Resume Token**
   ```javascript
   resumeToken: { storage: 'redis', redis: redisInstance }
   ```

3. **数据转换尽量轻量**
   ```javascript
   transform: (doc) => {
       delete doc.heavyField;  // 删除大字段
       return doc;
   }
   ```

---

## 🐛 已知限制

1. **必须是 Replica Set**: 单节点不支持 Change Stream
2. **初次启动无历史数据**: 只同步启动后的变更
3. **Resume Token 丢失**: 重启后从当前时间开始

---

_发布时间: 2026-01-17_  
_版本: v1.0.9_

