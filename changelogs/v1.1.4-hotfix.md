# Changelog v1.1.4-hotfix

> **å‘å¸ƒæ—¥æœŸ**: 2026-02-10  
> **ç‰ˆæœ¬ç±»å‹**: æ–‡æ¡£ä¿®å¤ (Documentation Fix)  
> **ä¿®å¤å†…å®¹**: ä¿®æ­£ v1.1.4 ä¸­çš„æ–‡æ¡£é”™è¯¯å’Œç¼ºå¤±

---

## ğŸ”§ æ–‡æ¡£ä¿®å¤

### 1. é›†åˆä¾èµ–è‡ªåŠ¨å¤±æ•ˆåŠŸèƒ½è¯´æ˜ä¿®æ­£

**é—®é¢˜**: v1.1.4 æ–‡æ¡£å£°ç§°æ”¯æŒé›†åˆä¾èµ–è‡ªåŠ¨å¤±æ•ˆåŠŸèƒ½ï¼Œä½†ä»£ç ä¸­æœªå®ç°

**å½±å“æ–‡ä»¶**:
- `docs/function-cache.md`
- `changelogs/v1.1.4.md`

**ä¿®å¤å†…å®¹**:
- âŒ ç§»é™¤äº†å…³äº"MongoDB å†™æ“ä½œä¼šè‡ªåŠ¨å¤±æ•ˆç›¸å…³å‡½æ•°ç¼“å­˜"çš„è¯¯å¯¼æ€§æè¿°
- âœ… æ·»åŠ äº†æ­£ç¡®çš„ä½¿ç”¨è¯´æ˜ï¼šæ•°æ®æ›´æ–°åéœ€è¦æ‰‹åŠ¨å¤±æ•ˆç¼“å­˜
- âœ… æä¾›äº†æ­£ç¡®çš„æ‰‹åŠ¨å¤±æ•ˆç¤ºä¾‹ä»£ç 

**ä¿®å¤å‰**ï¼ˆé”™è¯¯ï¼‰:
```javascript
// å½“ MongoDB é›†åˆæ›´æ–°æ—¶ï¼Œç›¸å…³å‡½æ•°ç¼“å­˜è‡ªåŠ¨å¤±æ•ˆ
await msq.collection('users').updateOne({ _id: 'user123' }, { $set: { name: 'Alice' } });
// âœ… getUserProfile çš„ç¼“å­˜å·²è‡ªåŠ¨å¤±æ•ˆ
```

**ä¿®å¤å**ï¼ˆæ­£ç¡®ï¼‰:
```javascript
// âš ï¸ é‡è¦ï¼šæ•°æ®æ›´æ–°åéœ€è¦æ‰‹åŠ¨å¤±æ•ˆç¼“å­˜
await msq.collection('users').updateOne({ _id: 'user123' }, { $set: { name: 'Alice' } });
await fnCache.invalidate('getUserProfile', 'user123'); // æ‰‹åŠ¨å¤±æ•ˆç¼“å­˜
```

**æŠ€æœ¯è¯´æ˜**:
- `_registerDependencies` æ–¹æ³•ç›®å‰åªå­˜å‚¨ä¾èµ–å…³ç³»ï¼Œä¸æ‰§è¡Œå®é™…çš„è‡ªåŠ¨å¤±æ•ˆé€»è¾‘
- `collections` å‚æ•°å¯ä»¥ä¿ç•™ï¼ˆç”¨äºæ–‡æ¡£è®°å½•ï¼‰ï¼Œä½†ä¸ä¼šè§¦å‘è‡ªåŠ¨å¤±æ•ˆ
- ç”¨æˆ·å¿…é¡»åœ¨æ•°æ®æ›´æ–°åæ‰‹åŠ¨è°ƒç”¨ `invalidate()` æ–¹æ³•

---

### 2. TypeScript ç±»å‹å®šä¹‰éªŒè¯

**é—®é¢˜**: éœ€è¦ç¡®è®¤ TypeScript ç±»å‹å®šä¹‰æ˜¯å¦å®Œæ•´

**éªŒè¯ç»“æœ**: âœ… å·²éªŒè¯

**ç±»å‹å®šä¹‰æ–‡ä»¶**:
- `index.d.ts` - ä¸»ç±»å‹å®šä¹‰æ–‡ä»¶ï¼ˆå·²å¯¼å‡º `withCache` å’Œ `FunctionCache`ï¼‰
- `types/function-cache.d.ts` - å‡½æ•°ç¼“å­˜ç±»å‹å®šä¹‰ï¼ˆå·²å®Œæ•´ï¼‰

**å¯¼å‡ºçš„ç±»å‹**:
```typescript
export interface WithCacheOptions { }
export interface CacheStats { }
export interface FunctionCacheOptions { }
export type CachedFunction<T> = T & { getCacheStats(): CacheStats };
export function withCache<T>(fn: T, options?: WithCacheOptions<T>): CachedFunction<T>;
export class FunctionCache { }
```

**çŠ¶æ€**: âœ… TypeScript æ”¯æŒå®Œæ•´ï¼Œæ— éœ€ä¿®æ”¹

---

## ğŸ“Š å½±å“èŒƒå›´

| å˜æ›´ç±»å‹ | æ–‡ä»¶æ•° | ç ´åæ€§ | è¯´æ˜ |
|---------|-------|--------|------|
| **æ–‡æ¡£ä¿®æ­£** | 2 | âŒ å¦ | ä¿®æ­£è¯¯å¯¼æ€§æ–‡æ¡£ |
| **ç±»å‹éªŒè¯** | 2 | âŒ å¦ | ç¡®è®¤ç±»å‹å®šä¹‰å®Œæ•´ |
| **ä»£ç å˜æ›´** | 0 | âŒ å¦ | æ— ä»£ç å˜æ›´ |

---

## ğŸ¯ ç”¨æˆ·è¡ŒåŠ¨å»ºè®®

### å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ v1.1.4

**âŒ ä¸è¦ä¾èµ–è‡ªåŠ¨å¤±æ•ˆåŠŸèƒ½**

å¦‚æœä½ çš„ä»£ç ä¾èµ–äºé›†åˆä¾èµ–è‡ªåŠ¨å¤±æ•ˆåŠŸèƒ½ï¼Œè¯·ç«‹å³ä¿®æ”¹ï¼š

```javascript
// âŒ é”™è¯¯ï¼šå‡è®¾ä¼šè‡ªåŠ¨å¤±æ•ˆ
fnCache.register('getUserProfile', getUserProfileFn, {
    collections: ['users']  // è¿™ä¸ä¼šè§¦å‘è‡ªåŠ¨å¤±æ•ˆ
});
await msq.collection('users').updateOne(...);
// ç¼“å­˜ä¸ä¼šè‡ªåŠ¨å¤±æ•ˆï¼

// âœ… æ­£ç¡®ï¼šæ‰‹åŠ¨å¤±æ•ˆ
fnCache.register('getUserProfile', getUserProfileFn, {
    ttl: 300000
});
await msq.collection('users').updateOne(...);
await fnCache.invalidate('getUserProfile', userId); // æ‰‹åŠ¨å¤±æ•ˆ
```

**å‡çº§æ“ä½œ**:
1. æ£€æŸ¥ä½ çš„ä»£ç ä¸­æ˜¯å¦ä½¿ç”¨äº† `collections` å‚æ•°
2. åœ¨æ‰€æœ‰æ•°æ®æ›´æ–°æ“ä½œåæ·»åŠ  `invalidate()` è°ƒç”¨
3. æµ‹è¯•ç¼“å­˜å¤±æ•ˆé€»è¾‘æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

## ğŸ“ æŠ€æœ¯å€ºåŠ¡

### å¾…å®ç°åŠŸèƒ½ï¼ˆv1.2.0 è®¡åˆ’ï¼‰

**é›†åˆä¾èµ–è‡ªåŠ¨å¤±æ•ˆåŠŸèƒ½**

å¦‚æœç¤¾åŒºæœ‰éœ€æ±‚ï¼Œå¯ä»¥åœ¨æœªæ¥ç‰ˆæœ¬å®ç°ï¼š

1. **å®ç°æ–¹æ¡ˆ**:
   ```javascript
   // lib/mongodb/collection.js
   async updateOne(filter, update, options) {
       const result = await this._adapter.updateOne(filter, update, options);
       
       // è‡ªåŠ¨å¤±æ•ˆå‡½æ•°ç¼“å­˜
       if (this._msq._functionCache) {
           await this._msq._functionCache._invalidateByCollection(this.name);
       }
       
       return result;
   }
   
   // lib/function-cache.js
   async _invalidateByCollection(collectionName) {
       const depsKey = `fn_deps:${collectionName}`;
       const functions = await this.cache.get(depsKey);
       
       if (functions && Array.isArray(functions)) {
           for (const fnName of functions) {
               await this.invalidatePattern(`${fnName}:*`);
           }
       }
   }
   ```

2. **å·¥ä½œé‡**: ä¸­ç­‰ï¼ˆéœ€è¦åœ¨æ‰€æœ‰å†™æ“ä½œä¸­é›†æˆ Hookï¼‰

3. **é£é™©è¯„ä¼°**:
   - æ€§èƒ½å½±å“ï¼šæ¯æ¬¡å†™æ“ä½œéƒ½éœ€è¦æ£€æŸ¥ä¾èµ–å…³ç³»
   - å¯é æ€§ï¼šéœ€è¦ç¡®ä¿æ‰€æœ‰å†™æ“ä½œéƒ½è§¦å‘å¤±æ•ˆ
   - å¤æ‚æ€§ï¼šéœ€è¦ç»´æŠ¤å®Œæ•´çš„ä¾èµ–å…³ç³»å›¾

4. **å†³ç­–**: æš‚ä¸å®ç°ï¼Œä¼˜å…ˆä¿æŒç®€å•æ€§

---

## ğŸ”— ç›¸å…³é“¾æ¥

- **GitHub Issue**: å¾…åˆ›å»º
- **åŸå§‹ CHANGELOG**: [v1.1.4.md](./v1.1.4.md)
- **ç”¨æˆ·æ–‡æ¡£**: [function-cache.md](../docs/function-cache.md)
- **åˆ†ææŠ¥å‘Š**: [function-cache-analysis.md](../reports/function-cache-analysis.md)

---

## ğŸ“‹ æ–‡ä»¶å˜æ›´æ¸…å•

```diff
docs/function-cache.md
- // æ³¨å†Œå‡½æ•°ï¼ˆæ”¯æŒé›†åˆä¾èµ–å£°æ˜ï¼‰
- collections: ['users', 'orders']  // ğŸ†• v1.1.4: å£°æ˜ä¾èµ–çš„é›†åˆ
- // å½“ MongoDB é›†åˆæ›´æ–°æ—¶ï¼Œç›¸å…³å‡½æ•°ç¼“å­˜è‡ªåŠ¨å¤±æ•ˆ
- // âœ… getUserProfile çš„ç¼“å­˜å·²è‡ªåŠ¨å¤±æ•ˆ

+ // æ³¨å†Œå‡½æ•°
+ // âš ï¸ é‡è¦ï¼šæ•°æ®æ›´æ–°åéœ€è¦æ‰‹åŠ¨å¤±æ•ˆç¼“å­˜
+ await fnCache.invalidate('getUserProfile', 'user123'); // æ‰‹åŠ¨å¤±æ•ˆç¼“å­˜
```

---

## âœ… éªŒè¯æ¸…å•

- [x] æ–‡æ¡£é”™è¯¯å·²ä¿®æ­£
- [x] TypeScript ç±»å‹å®šä¹‰å·²éªŒè¯
- [x] ç”¨æˆ·æ–‡æ¡£å·²æ›´æ–°
- [x] CHANGELOG å·²æ›´æ–°
- [x] åˆ†ææŠ¥å‘Šå·²ç”Ÿæˆ
- [x] æ— ç ´åæ€§å˜æ›´

---

**å‘å¸ƒæ—¶é—´**: 2026-02-10  
**ç»´æŠ¤è€…**: monSQLize Team  
**å®¡é˜…**: AI Assistant + Human Review

