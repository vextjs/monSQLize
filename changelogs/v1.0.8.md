# v1.0.8 å˜æ›´æ—¥å¿—

> **å‘å¸ƒæ—¥æœŸ**: 2026-01-15  
> **é‡è¦æ€§**: â­â­â­â­  
> **ç±»å‹**: æ–°åŠŸèƒ½ (Feature)

---

## ğŸ“‹ å˜æ›´æ¦‚è¿°

### âœ¨ æ–°åŠŸèƒ½

**Update æ–¹æ³•æ”¯æŒèšåˆç®¡é“ (Aggregation Pipeline)**

ä» v1.0.8 å¼€å§‹ï¼Œ`updateOne`ã€`updateMany`ã€`updateBatch` ä¸‰ä¸ªæ–¹æ³•å…¨é¢æ”¯æŒèšåˆç®¡é“è¯­æ³•ï¼Œæä¾›æ›´å¼ºå¤§çš„å­—æ®µè®¡ç®—å’Œè½¬æ¢èƒ½åŠ›ã€‚

---

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### 1. æ”¯æŒèšåˆç®¡é“è¯­æ³• âœ¨

**å½±å“èŒƒå›´**: updateOne, updateMany, updateBatch

**æ–°å¢åŠŸèƒ½**:
- âœ… å­—æ®µé—´è®¡ç®—ï¼ˆå¼•ç”¨å…¶ä»–å­—æ®µï¼‰
- âœ… æ¡ä»¶è¡¨è¾¾å¼ï¼ˆ$condã€$switchï¼‰
- âœ… æ•°ç»„æ“ä½œï¼ˆ$arrayElemAtã€$sizeï¼‰
- âœ… å­—ç¬¦ä¸²æ“ä½œï¼ˆ$concatã€$trimï¼‰
- âœ… æ—¥æœŸè®¡ç®—ï¼ˆ$addã€$subtractï¼‰
- âœ… å¤šé˜¶æ®µè½¬æ¢ï¼ˆå¤šä¸ª $set/$unsetï¼‰

**ä½¿ç”¨ç¤ºä¾‹**:

```javascript
// å­—æ®µé—´è®¡ç®— - è®¢å•æ€»ä»·
await orders.updateOne(
    { orderId: 'ORDER-123' },
    [
        {
            $set: {
                totalPrice: {
                    $add: [
                        { $multiply: ['$unitPrice', '$quantity'] },
                        '$shippingFee'
                    ]
                }
            }
        }
    ]
);

// æ¡ä»¶èµ‹å€¼ - è‡ªåŠ¨è®¾ç½®ä¼šå‘˜ç­‰çº§
await users.updateOne(
    { userId: 'user1' },
    [
        {
            $set: {
                memberLevel: {
                    $switch: {
                        branches: [
                            { case: { $gte: ['$points', 10000] }, then: 'platinum' },
                            { case: { $gte: ['$points', 5000] }, then: 'gold' }
                        ],
                        default: 'bronze'
                    }
                }
            }
        }
    ]
);

// å¤šé˜¶æ®µè½¬æ¢ - æ•°æ®æ¸…æ´—
await products.updateOne(
    { productId: 'p789' },
    [
        // é˜¶æ®µ1: è§„èŒƒåŒ–
        { $set: { name: { $trim: { input: '$name' } } } },
        // é˜¶æ®µ2: è®¡ç®—
        { $set: { discountedPrice: { $multiply: ['$price', 0.9] } } },
        // é˜¶æ®µ3: æ—¶é—´æˆ³
        { $set: { updatedAt: new Date() } }
    ]
);
```

### 2. å®Œæ•´çš„å‚æ•°éªŒè¯ âœ…

**æ–°å¢éªŒè¯**:
- âœ… èšåˆç®¡é“å¿…é¡»æ˜¯æ•°ç»„ç±»å‹
- âœ… èšåˆç®¡é“ä¸èƒ½ä¸ºç©ºæ•°ç»„
- âœ… æ¯ä¸ªé˜¶æ®µå¿…é¡»æ˜¯å¯¹è±¡
- âœ… æ¯ä¸ªé˜¶æ®µä¸èƒ½ä¸ºç©ºå¯¹è±¡
- âœ… æ“ä½œç¬¦å¿…é¡»ä»¥ $ å¼€å¤´
- âœ… ç©ºå¯¹è±¡æ£€æµ‹ï¼ˆä¿®å¤ä¹‹å‰çš„bugï¼‰

**é”™è¯¯æç¤ºä¼˜åŒ–**:

```javascript
// âŒ ç©ºæ•°ç»„
await users.updateOne({}, []);
// Error: update èšåˆç®¡é“ä¸èƒ½ä¸ºç©ºæ•°ç»„

// âŒ æ— æ•ˆæ“ä½œç¬¦
await users.updateOne({}, [{ invalidOp: {} }]);
// Error: èšåˆç®¡é“ç¬¬ 1 ä¸ªé˜¶æ®µçš„æ“ä½œç¬¦å¿…é¡»ä»¥ $ å¼€å¤´ï¼Œå½“å‰: invalidOp

// âŒ MongoDB ç‰ˆæœ¬ä¸æ”¯æŒ
await users.updateOne({}, [{ $set: { a: 1 } }]);
// Error: MongoDB 4.2+ æ‰æ”¯æŒèšåˆç®¡é“æ›´æ–°ã€‚è¯·å‡çº§ MongoDB ç‰ˆæœ¬æˆ–ä½¿ç”¨ä¼ ç»Ÿæ›´æ–°æ“ä½œç¬¦
//        requirement: 'MongoDB 4.2+'
//        documentation: 'https://www.mongodb.com/docs/manual/...'
```

### 3. æ™ºèƒ½ ObjectId è½¬æ¢ âœ…

**è¡Œä¸ºå˜æ›´**:
- ä¼ ç»Ÿæ“ä½œç¬¦ï¼ˆObject æ ¼å¼ï¼‰: ç»§ç»­è‡ªåŠ¨è½¬æ¢ ObjectId
- èšåˆç®¡é“ï¼ˆArray æ ¼å¼ï¼‰: ä¿æŒåŸæ ·ï¼Œä¸è½¬æ¢

**åŸå› **: èšåˆç®¡é“ä¸­çš„å­—ç¬¦ä¸²å¯èƒ½æ˜¯å­—æ®µå¼•ç”¨ï¼ˆå¦‚ `'$userId'`ï¼‰ï¼Œä¸åº”è¯¥è½¬æ¢ã€‚

```javascript
// ä¼ ç»Ÿæ–¹å¼ - è‡ªåŠ¨è½¬æ¢
await users.updateOne(
    { _id: 'userId' },  // âœ… è‡ªåŠ¨è½¬æ¢ä¸º ObjectId
    { $set: { refId: 'refId123' } }  // âœ… è‡ªåŠ¨è½¬æ¢
);

// èšåˆç®¡é“ - ä¿æŒåŸæ ·
await users.updateOne(
    { _id: 'userId' },  // âœ… è‡ªåŠ¨è½¬æ¢
    [
        { $set: { refId: '$otherId' } }  // âœ… ä¿æŒå­—ç¬¦ä¸²ï¼ˆå­—æ®µå¼•ç”¨ï¼‰
    ]
);
```

### 4. è¯¦ç»†çš„æ—¥å¿—è®°å½• âœ…

**æ–°å¢æ—¥å¿—å­—æ®µ**:
- `updateType`: `'aggregation-pipeline'` | `'update-operators'`
- `pipelineStages`: èšåˆç®¡é“é˜¶æ®µæ•°é‡

**æ—¥å¿—ç¤ºä¾‹**:

```javascript
[DEBUG] [updateOne] ä½¿ç”¨èšåˆç®¡é“æ¨¡å¼ {
  collection: 'users',
  stagesCount: 2,
  operators: ['$set', '$unset']
}

[DEBUG] [updateOne] æ“ä½œå®Œæˆ {
  ns: 'mydb.users',
  duration: 5,
  updateType: 'aggregation-pipeline',  // âœ¨ æ–°å¢
  pipelineStages: 2,                    // âœ¨ æ–°å¢
  matchedCount: 1,
  modifiedCount: 1
}
```

---

## ğŸ› Bug ä¿®å¤

### 1. ä¿®å¤ç©ºå¯¹è±¡éªŒè¯é—®é¢˜ âœ…

**é—®é¢˜**: ç©ºå¯¹è±¡ `{}` ä¼šé€šè¿‡éªŒè¯ï¼Œå¯¼è‡´æ— æ„ä¹‰çš„æ›´æ–°æ“ä½œã€‚

**ä¿®å¤å‰**:
```javascript
// âŒ ç©ºå¯¹è±¡ä¼šé€šè¿‡éªŒè¯
await users.updateOne({ _id }, {});  // ä¸æŠ¥é”™ï¼Œä½†æ— æ„ä¹‰
```

**ä¿®å¤å**:
```javascript
// âœ… ç©ºå¯¹è±¡ä¼šæŠ›å‡ºé”™è¯¯
await users.updateOne({ _id }, {});
// Error: update ä¸èƒ½ä¸ºç©ºå¯¹è±¡
//        update å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ›´æ–°æ“ä½œç¬¦ï¼Œå¦‚ $setã€$incã€$push ç­‰
```

### 2. å¢åŠ  MongoDB ç‰ˆæœ¬é”™è¯¯æç¤º âœ…

**é—®é¢˜**: MongoDB 4.2 ä»¥ä¸‹ç‰ˆæœ¬ä¸æ”¯æŒèšåˆç®¡é“ï¼Œä½†é”™è¯¯ä¿¡æ¯ä¸æ¸…æ™°ã€‚

**ä¿®å¤å‰**:
```javascript
// âŒ é”™è¯¯ä¿¡æ¯éš¾ä»¥ç†è§£
await users.updateOne({}, [{ $set: { a: 1 } }]);
// MongoServerError: Unrecognized pipeline stage name: '$set'
```

**ä¿®å¤å**:
```javascript
// âœ… å‹å¥½çš„é”™è¯¯æç¤º
await users.updateOne({}, [{ $set: { a: 1 } }]);
// Error: MongoDB 4.2+ æ‰æ”¯æŒèšåˆç®¡é“æ›´æ–°ã€‚è¯·å‡çº§ MongoDB ç‰ˆæœ¬æˆ–ä½¿ç”¨ä¼ ç»Ÿæ›´æ–°æ“ä½œç¬¦
//        requirement: 'MongoDB 4.2+'
//        currentError: 40324
//        documentation: 'https://www.mongodb.com/docs/manual/tutorial/update-documents-with-aggregation-pipeline/'
```

---

## ğŸ“ æ–‡æ¡£æ›´æ–°

### æ–°å¢æ–‡æ¡£

1. **Update æ“ä½œè¯¦è§£** (`docs/update-operations.md`)
   - èšåˆç®¡é“åŸºç¡€æ¦‚å¿µ
   - 7 ä¸ªå®Œæ•´ä½¿ç”¨åœºæ™¯
   - ä¸ä¼ ç»Ÿæ–¹å¼å¯¹æ¯”
   - æœ€ä½³å®è·µ
   - æ€§èƒ½è€ƒè™‘
   - å¸¸è§é—®é¢˜

2. **ç¤ºä¾‹ä»£ç ** (`examples/update-aggregation-pipeline.examples.js`)
   - 7 ä¸ªå¯è¿è¡Œçš„å®Œæ•´ç¤ºä¾‹
   - åŒ…å«æµ‹è¯•æ•°æ®å‡†å¤‡
   - åŒ…å«ç»“æœéªŒè¯

### æ›´æ–°æ–‡æ¡£

1. **README.md**
   - ç‰¹æ€§åˆ—è¡¨ä¸­æ·»åŠ èšåˆç®¡é“æ”¯æŒæ ‡è®°

2. **CHANGELOG.md**
   - æ·»åŠ  v1.0.8 ç‰ˆæœ¬è®°å½•

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

### æµ‹è¯•é€šè¿‡æƒ…å†µ

| æµ‹è¯•å¥—ä»¶ | é€šè¿‡/æ€»æ•° | çŠ¶æ€ |
|----------|----------|------|
| updateOne | 25/25 | âœ… å…¨éƒ¨é€šè¿‡ |
| updateMany | 22/22 | âœ… å…¨éƒ¨é€šè¿‡ |
| updateBatch | 17/17 | âœ… å…¨éƒ¨é€šè¿‡ |
| **æ€»è®¡** | **64/64** | âœ… **å…¨éƒ¨é€šè¿‡** |

### æ–°å¢æµ‹è¯•

- âœ… updateOne: åº”è¯¥æ”¯æŒèšåˆç®¡é“æ ¼å¼çš„ update
- âœ… updateOne: åº”è¯¥åœ¨ update ä¸ºç©ºæ•°ç»„æ—¶æŠ›å‡ºé”™è¯¯
- âœ… updateBatch: å‚æ•°éªŒè¯å·²ä¿®å¤

### å‘åå…¼å®¹æ€§

âœ… **æ‰€æœ‰ç°æœ‰æµ‹è¯•ï¼ˆ61ä¸ªï¼‰ç»§ç»­æ­£å¸¸å·¥ä½œ**
âœ… **æ²¡æœ‰ç ´åä»»ä½•ç°æœ‰åŠŸèƒ½**
âœ… **API ç­¾åå®Œå…¨å…¼å®¹**

---

## ğŸ’» ä»£ç å˜æ›´

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|------|------|------|
| `lib/mongodb/common/aggregation-validator.js` | 124 | èšåˆç®¡é“éªŒè¯å·¥å…· |
| `docs/update-operations.md` | 700+ | Update æ“ä½œè¯¦ç»†æ–‡æ¡£ |
| `examples/update-aggregation-pipeline.examples.js` | 370+ | 7 ä¸ªå®Œæ•´ç¤ºä¾‹ |
| `changelogs/v1.0.8.md` | æœ¬æ–‡ä»¶ | å˜æ›´æ—¥å¿— |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ | è¯´æ˜ |
|------|------|------|
| `lib/mongodb/writes/update-one.js` | +60è¡Œ | æ”¯æŒèšåˆç®¡é“ + ä¿®å¤3ä¸ªé—®é¢˜ |
| `lib/mongodb/writes/update-many.js` | +60è¡Œ | æ”¯æŒèšåˆç®¡é“ + ä¿®å¤3ä¸ªé—®é¢˜ |
| `lib/mongodb/writes/update-batch.js` | +70è¡Œ | æ”¯æŒèšåˆç®¡é“ + ä¿®å¤3ä¸ªé—®é¢˜ |
| `test/unit/features/updateOne.test.js` | ä¿®æ”¹2ä¸ª | æµ‹è¯•å…¼å®¹æ€§ä¿®å¤ |
| `test/unit/features/updateBatch.test.js` | ä¿®æ”¹1ä¸ª | æµ‹è¯•å…¼å®¹æ€§ä¿®å¤ |
| `README.md` | +1è¡Œ | æ·»åŠ èšåˆç®¡é“æ”¯æŒæ ‡è®° |
| `CHANGELOG.md` | +1è¡Œ | æ·»åŠ ç‰ˆæœ¬è®°å½• |

---

## ğŸš€ å‡çº§æŒ‡å—

### å…¼å®¹æ€§

âœ… **å®Œå…¨å‘åå…¼å®¹** - æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 

### MongoDB ç‰ˆæœ¬è¦æ±‚

**ä½¿ç”¨èšåˆç®¡é“** éœ€è¦ MongoDB 4.2+

**ä¼ ç»Ÿæ›´æ–°æ“ä½œç¬¦** ç»§ç»­æ”¯æŒæ‰€æœ‰ç‰ˆæœ¬

### å‡çº§æ­¥éª¤

```bash
# 1. å‡çº§ monSQLize
npm install monsqlize@1.0.8

# 2. æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç ï¼ˆå®Œå…¨å‘åå…¼å®¹ï¼‰

# 3. å¯é€‰ï¼šä½¿ç”¨æ–°çš„èšåˆç®¡é“åŠŸèƒ½
```

### åŠŸèƒ½å¯ç”¨

**è‡ªåŠ¨å¯ç”¨** - æ— éœ€é…ç½®

å½“ `update` å‚æ•°ä¸ºæ•°ç»„æ—¶ï¼Œè‡ªåŠ¨è¯†åˆ«ä¸ºèšåˆç®¡é“ï¼š

```javascript
// ä¼ ç»Ÿæ–¹å¼ - ç»§ç»­æ­£å¸¸å·¥ä½œ
await users.updateOne({ _id }, { $set: { name: 'Alice' } });

// èšåˆç®¡é“ - è‡ªåŠ¨è¯†åˆ«
await users.updateOne({ _id }, [{ $set: { name: 'Alice' } }]);
```

---

## ğŸ“š ç›¸å…³èµ„æº

### æ–‡æ¡£

- [Update æ“ä½œè¯¦è§£](../docs/update-operations.md)
- [å®Œæ•´ç¤ºä¾‹ä»£ç ](../examples/update-aggregation-pipeline.examples.js)
- [MongoDB å®˜æ–¹æ–‡æ¡£](https://www.mongodb.com/docs/manual/tutorial/update-documents-with-aggregation-pipeline/)

### æµ‹è¯•

- [updateOne æµ‹è¯•](../test/unit/features/updateOne.test.js)
- [updateMany æµ‹è¯•](../test/unit/features/updateMany.test.js)
- [updateBatch æµ‹è¯•](../test/unit/features/updateBatch.test.js)

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

v1.1.0 å°†ç»§ç»­å®æ–½ä»¥ä¸‹åŠŸèƒ½ï¼ˆæ ¹æ®éœ€æ±‚ä¼˜å…ˆçº§ï¼‰ï¼š

1. â³ å¤šè¿æ¥æ± åŠŸèƒ½ï¼ˆè¯»å†™åˆ†ç¦»ã€è´Ÿè½½å‡è¡¡ï¼‰
2. â³ Saga åˆ†å¸ƒå¼äº‹åŠ¡å›æ»šæœºåˆ¶
3. â³ å…¶ä»–æ€§èƒ½ä¼˜åŒ–å’Œç‰¹æ€§å¢å¼º

---

## ğŸ™ è‡´è°¢

æ„Ÿè°¢æ‰€æœ‰ç”¨æˆ·çš„åé¦ˆå’Œå»ºè®®ï¼

---

**å˜æ›´æ—¥å¿—ç‰ˆæœ¬**: v1.0.0  
**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-01-15

