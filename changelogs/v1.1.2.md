# v1.1.2 变更日志

**发布日期**: 2026-01-27  
**版本类型**: Patch（补丁版本）  
**重要性**: ⭐⭐⭐

---

## 📋 版本概览

v1.1.2 是一个优化版本，主要解决用户反馈的日志问题：

1. **ObjectId 转换日志默认静默**：根据用户反馈，默认不输出任何 ObjectId 转换日志
2. **Saga 日志修复**：修复误导性的 Redis 日志提示

---

## 🎯 核心改进

### 1. ObjectId 转换日志默认静默

#### 问题背景

v1.1.1 引入了跨版本 ObjectId 兼容性功能，但每次转换都会输出 DEBUG 日志：

```
[DEBUG] [ObjectId Converter] Cross-version ObjectId converted { ... }
[DEBUG] [ObjectId Converter] Cross-version ObjectId converted { ... }
... (数百条重复日志)
```

**用户反馈**：
- ❌ 日志过多，污染输出
- ❌ ObjectId 转换是自动的，日志没有实际作用
- ❌ 增加日志存储开销

#### 解决方案

**默认完全静默** - v1.1.2 默认不输出任何 ObjectId 转换日志

```javascript
// 默认配置（完全静默）
const msq = new MonSQLize({
  type: 'mongodb',
  config: { uri: 'mongodb://localhost:27017' }
});

await msq.collection('users').insertOne(dataWithObjectIds);
// ✅ 无任何日志输出
```

#### 配置选项

支持三种日志模式：

| 模式 | silent | verbose | 日志输出 | 适用场景 |
|------|--------|---------|---------|---------|
| **静默模式**（默认）✅ | `true` | - | 无 | 生产环境、日常开发 |
| **摘要模式** | `false` | `false` | 1条摘要 | 需要了解转换情况时 |
| **详细模式** | `false` | `true` | N条详情 | 深度调试、排查问题 |

**启用摘要日志**：

```javascript
const msq = new MonSQLize({
  type: 'mongodb',
  config: { uri: 'mongodb://localhost:27017' },
  autoConvertObjectId: {
    silent: false  // 关闭静默
  }
});
// 输出：[DEBUG] Converted 15 cross-version ObjectIds
```

**启用详细日志**：

```javascript
const msq = new MonSQLize({
  type: 'mongodb',
  config: { uri: 'mongodb://localhost:27017' },
  autoConvertObjectId: {
    silent: false,
    verbose: true
  }
});
// 输出：每个 ObjectId 都有一条日志
```

#### 修改的文件

**文件**: `lib/utils/objectid-converter.js`

**主要改动**：
```javascript
const {
  logger = null,
  excludeFields = [],
  customFieldPatterns = [],
  maxDepth = 10,
  verbose = false,
  silent = true,    // 🆕 默认静默（不输出任何日志）
  _conversionStats = null
} = options;

// 日志输出逻辑
if (!silent && verbose && logger && logger.debug) {
  // 详细日志（只在 silent=false 且 verbose=true 时输出）
}

if (!silent && isTopLevel && stats.count > 0 && logger && logger.debug) {
  // 摘要日志（只在 silent=false 时输出）
}
```

---

### 2. Saga 日志修复

#### 问题背景

即使没有连接 Redis，初始化时也会输出误导性日志：

```
[DEBUG] [Saga] 使用 Redis 存储（多进程共享）
```

**实际情况**：只启用了内存缓存，并非 Redis。

#### 解决方案

修复 `lib/saga/SagaOrchestrator.js` 的判断逻辑，通过检测 Redis 特有的方法来准确识别：

**修改前**（错误）：
```javascript
if (this.cache && typeof this.cache.set === 'function') {
  this.useRedis = true;
  this.logger?.debug('[Saga] 使用 Redis 存储（多进程共享）');
}
```

**修改后**（正确）：
```javascript
// 检测是否为 Redis（通过检查特定方法）
const isRedis = typeof this.cache.keys === 'function' && 
               typeof this.cache.publish === 'function';

if (isRedis) {
  this.useRedis = true;
  this.logger?.debug('[Saga] 使用 Redis 存储（多进程共享）');
} else {
  this.sagas = new Map();
  this.useRedis = false;
  this.logger?.debug('[Saga] 使用内存缓存（单进程，Saga 元数据不共享）');
}
```

#### 修改的文件

**文件**: `lib/saga/SagaOrchestrator.js`

**位置**: 第 15-34 行

---

## 📊 效果对比

### ObjectId 转换日志

#### 场景：插入包含 15 个 ObjectId 的文档

**v1.1.1**（有日志）：
```
[DEBUG] [ObjectId Converter] Cross-version ObjectId converted { ... }
[DEBUG] [ObjectId Converter] Cross-version ObjectId converted { ... }
... (共15条日志)
```

**v1.1.2**（默认）：
```
✅ 插入成功
（无任何 ObjectId 转换日志）
```

**日志减少**: 100% ✅

### Saga 日志

**v1.1.1**（错误）：
```
[DEBUG] [Saga] 使用 Redis 存储（多进程共享）
（实际只是内存缓存）
```

**v1.1.2**（正确）：
```
[DEBUG] [Saga] 使用内存缓存（单进程，Saga 元数据不共享）
（准确描述）
```

---

## 🧪 测试验证

### 1. ObjectId 转换测试

```bash
# 运行测试，验证默认无日志输出
cd E:\MySelf\monSQLize
node scripts/test/verify-cross-version-objectid.js 2>&1 | Select-String "ObjectId Converter"

# 结果：无任何输出 ✅
```

### 2. 单元测试

```bash
# 所有测试通过
npm test

# 结果：
# 60 passing (608ms)
# 22 passing (2s)
# 408 passing (6s)
```

---

## 📚 文档更新

### 新增文档

1. **`docs/objectid-logging-optimization.md`**
   - 详细的日志配置说明
   - 三种模式的对比
   - 配置示例

2. **`reports/jrpc/optimization/objectid-logging-optimization-v1.1.2.md`**
   - 完整的优化报告
   - 效果对比

3. **`reports/jrpc/summary/objectid-logging-silent-v1.1.2.md`**
   - 用户需求总结
   - 解决方案说明

### 更新文档

1. **`docs/objectid-cross-version-faq.md`**
   - 新增 Q3：为什么有这么多转换日志？如何关闭？
   - 回答：v1.1.2 默认已经完全静默

2. **`CHANGELOG.md`**
   - 添加 v1.1.2 版本记录

---

## 🔄 升级指南

### 从 v1.1.1 升级到 v1.1.2

#### 无需任何代码修改

v1.1.2 完全向后兼容，直接升级即可：

```bash
npm install monsqlize@1.1.2
```

#### 行为变化

**默认情况**（推荐）：
- ✅ 不再输出 ObjectId 转换日志
- ✅ Saga 日志更准确

**如需恢复 v1.1.1 的日志行为**：

```javascript
const msq = new MonSQLize({
  type: 'mongodb',
  config: { uri: 'mongodb://localhost:27017' },
  autoConvertObjectId: {
    silent: false  // 启用摘要日志
  }
});
```

---

## ⚠️ 破坏性变更

**无破坏性变更** ✅

- 功能行为完全一致
- 只是日志输出的变化
- 向后兼容

---

## 🎯 下一步计划

### v1.1.3（计划中）

可能包含的改进：
- 性能优化
- 更多兼容性测试
- 文档完善

---

## 📞 反馈与支持

如有问题，请通过以下方式反馈：
- GitHub Issues: https://github.com/vextjs/monSQLize/issues
- Email: rockyshi1993@gmail.com

---

## 🙏 致谢

感谢用户提供的宝贵反馈，帮助我们持续改进 monSQLize！

---

**发布日期**: 2026-01-27  
**版本号**: v1.1.2  
**上一版本**: v1.1.1  
**下一版本**: v1.1.3（计划中）
