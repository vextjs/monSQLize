# v1.0.4 å˜æ›´è¯¦æƒ…

> **å‘å¸ƒæ—¥æœŸ**: 2026-01-07  
> **ä¸»é¢˜**: è™šæ‹Ÿå­—æ®µ + é»˜è®¤å€¼ + Bug ä¿®å¤

---

## æ ¸å¿ƒæ”¹è¿› âš¡

### æ–°å¢åŠŸèƒ½ âœ¨

#### 1. è™šæ‹Ÿå­—æ®µï¼ˆVirtualsï¼‰- è®¡ç®—å±æ€§

**åŠŸèƒ½è¯´æ˜**:
- è®¡ç®—å±æ€§ï¼Œä¸å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
- getter å‡½æ•°ï¼šå®šä¹‰è®¡ç®—é€»è¾‘ï¼ˆå¦‚ firstName + lastName = fullNameï¼‰
- setter å‡½æ•°ï¼šåå‘èµ‹å€¼æ”¯æŒï¼ˆå¯é€‰ï¼‰
- è‡ªåŠ¨æ³¨å…¥ï¼šæŸ¥è¯¢ç»“æœè‡ªåŠ¨åº”ç”¨è™šæ‹Ÿå­—æ®µ
- JSON åºåˆ—åŒ–ï¼šè™šæ‹Ÿå­—æ®µåœ¨ JSON.stringify ä¸­å¯è§

**ä½¿ç”¨ç¤ºä¾‹**:
```javascript
Model.define('users', {
    schema: (dsl) => dsl({
        firstName: 'string!',
        lastName: 'string!'
    }),
    virtuals: {
        fullName: {
            get: function() {
                return `${this.firstName} ${this.lastName}`;
            },
            set: function(value) {
                const parts = value.split(' ');
                this.firstName = parts[0];
                this.lastName = parts[1];
            }
        }
    }
});

// ä½¿ç”¨
const user = await User.findOne({ firstName: 'John' });
console.log(user.fullName); // 'John Doe'ï¼ˆè™šæ‹Ÿå­—æ®µï¼‰

// setter æ”¯æŒ
user.fullName = 'Jane Smith';
console.log(user.firstName); // 'Jane'
console.log(user.lastName);  // 'Smith'
```

---

#### 2. é»˜è®¤å€¼ï¼ˆDefaultsï¼‰- æ’å…¥æ—¶è‡ªåŠ¨å¡«å……

**åŠŸèƒ½è¯´æ˜**:
- é™æ€é»˜è®¤å€¼ï¼šå¦‚ status: 'active'
- å‡½æ•°é»˜è®¤å€¼ï¼šå¦‚ createdAt: () => new Date()
- ä¸Šä¸‹æ–‡é»˜è®¤å€¼ï¼šå¦‚ createdBy: (ctx) => ctx.userId
- è‡ªåŠ¨åº”ç”¨ï¼šinsertOne/insertMany æ—¶è‡ªåŠ¨å¡«å……
- ä¸è¦†ç›–å·²æä¾›çš„å€¼

**ä½¿ç”¨ç¤ºä¾‹**:
```javascript
Model.define('users', {
    schema: (dsl) => dsl({
        username: 'string!',
        status: 'string?',
        score: 'number?',
        createdAt: 'date?'
    }),
    defaults: {
        status: 'active',              // é™æ€å€¼
        score: 0,                      // é™æ€å€¼
        createdAt: () => new Date()    // å‡½æ•°å€¼
    }
});

// ä½¿ç”¨
await User.insertOne({ username: 'john' });
// è‡ªåŠ¨åº”ç”¨é»˜è®¤å€¼ï¼š
// status = 'active'
// score = 0
// createdAt = å½“å‰æ—¶é—´

// ä¸è¦†ç›–å·²æä¾›çš„å€¼
await User.insertOne({ 
    username: 'alice',
    status: 'inactive'  // ä¿ç•™ç”¨æˆ·æä¾›çš„å€¼
});
// status = 'inactive'ï¼ˆä¸ä¼šè¢«é»˜è®¤å€¼è¦†ç›–ï¼‰
```

---

### Bug ä¿®å¤ ğŸ›

#### åµŒå¥— Populate + Select é—®é¢˜ä¿®å¤ âœ…

**é—®é¢˜æè¿°**:
- åµŒå¥— populate é…ç½®ä¸­ä½¿ç”¨ select é€‰é¡¹æ—¶ï¼Œå…³è”æ•°æ®æœªå¡«å……
- è¡¨ç°ï¼šäºŒçº§åŠä»¥ä¸Šçš„å…³è”æ•°æ®ä¸ºç©ºæˆ– undefined

**æ ¹æœ¬åŸå› **:
- select é€‰é¡¹ä¼šè¿‡æ»¤æ‰ç”¨äºæ„å»ºå…³ç³»æ˜ å°„çš„å¤–é”®å­—æ®µ
- å¯¼è‡´ populate é€»è¾‘æ— æ³•æ‰¾åˆ°å…³è”æ•°æ®

**ä¿®å¤æ–¹æ¡ˆ**:
- åœ¨ `_selectFields` æ–¹æ³•ä¸­ä¿ç•™å¤–é”®å­—æ®µï¼ˆkeepField å‚æ•°ï¼‰
- ç¡®ä¿å¤–é”®å­—æ®µåœ¨å†…éƒ¨æ˜ å°„æ—¶å¯ç”¨ï¼Œä½†ä¸æš´éœ²ç»™ç”¨æˆ·

**æŠ€æœ¯ç»†èŠ‚**:
```javascript
// ä¿®å¤å‰ï¼šselect ä¼šè¿‡æ»¤æ‰å¤–é”®å­—æ®µ
_selectFields(doc, select) {
    const result = { _id: doc._id };
    select.forEach(field => {
        if (doc[field] !== undefined) {
            result[field] = doc[field];
        }
    });
    // âŒ å¤–é”®å­—æ®µè¢«è¿‡æ»¤ï¼Œå¯¼è‡´æ˜ å°„å¤±è´¥
    return result;
}

// ä¿®å¤åï¼šä¿ç•™å¤–é”®å­—æ®µç”¨äºå†…éƒ¨æ˜ å°„
_selectFields(doc, select, keepField) {
    const result = { _id: doc._id };
    select.forEach(field => {
        if (doc[field] !== undefined) {
            result[field] = doc[field];
        }
    });
    // âœ… ä¿ç•™å¤–é”®å­—æ®µï¼Œç¡®ä¿å…³ç³»æ˜ å°„æ­£ç¡®
    if (keepField && doc[keepField] !== undefined) {
        result[keepField] = doc[keepField];
    }
    return result;
}
```

**å½±å“èŒƒå›´**:
- ä»…å½±å“åµŒå¥— populate + select çš„ç»„åˆä½¿ç”¨
- ä¸å½±å“å•å±‚ populate æˆ–ä¸ä½¿ç”¨ select çš„åœºæ™¯

**å—å½±å“çš„ä½¿ç”¨åœºæ™¯**:
```javascript
// âŒ v1.0.3 ä¼šå¤±è´¥ï¼ˆcomments ä¸ºç©ºï¼‰
const user = await User.findOne({ _id }).populate({
    path: 'posts',
    populate: {
        path: 'comments',
        select: 'content'  // select ä¼šå¯¼è‡´é—®é¢˜
    }
});

// âœ… v1.0.4 å·²ä¿®å¤
// comments æ•°ç»„æ­£ç¡®å¡«å……ï¼Œä¸”åªåŒ…å« _id å’Œ content å­—æ®µ
```

**è¯¦ç»†æŠ¥å‘Š**: [nested-populate-bugfix-v1.3.0.md](../reports/monSQLize/patches/nested-populate-bugfix-v1.3.0.md)

---

## æµ‹è¯•æ”¹è¿› âœ…

### æ–°å¢æµ‹è¯•ç”¨ä¾‹ï¼ˆ31ä¸ªï¼Œ100%é€šè¿‡ï¼‰

**åµŒå¥— Populate æµ‹è¯•** (5ä¸ª):
- âœ… åŸºç¡€åµŒå¥— populate
- âœ… åµŒå¥— populate + select
- âœ… ä¸‰å±‚åµŒå¥— populate
- âœ… å¤šè·¯å¾„åµŒå¥— populate
- âœ… å¤æ‚æŸ¥è¯¢ + åµŒå¥— populate

**Relations è¾¹ç•Œæµ‹è¯•** (13ä¸ª):
- âœ… ç©ºæ•°ç»„å¤„ç†
- âœ… null/undefined å¤„ç†
- âœ… æ— æ•ˆå¤–é”®å¤„ç†
- âœ… å¾ªç¯å¼•ç”¨æ£€æµ‹
- âœ… æ··åˆç±»å‹å¤„ç†
- âœ… å¤§æ•°æ®é‡æµ‹è¯•ï¼ˆ1000+æ¡ï¼‰
- âœ… å¹¶å‘ populate æµ‹è¯•

**Populate é«˜çº§æµ‹è¯•** (8ä¸ª):
- âœ… select + populate ç»„åˆ
- âœ… sort + populate ç»„åˆ
- âœ… limit + populate ç»„åˆ
- âœ… match + populate ç»„åˆ
- âœ… å¤šä¸ª populate è·¯å¾„
- âœ… populate æ€§èƒ½æµ‹è¯•

**è™šæ‹Ÿå­—æ®µå’Œé»˜è®¤å€¼æµ‹è¯•** (10ä¸ª):
- âœ… åŸºç¡€è™šæ‹Ÿå­—æ®µï¼ˆgetterï¼‰
- âœ… è™šæ‹Ÿå­—æ®µ setter
- âœ… å¤šä¸ªè™šæ‹Ÿå­—æ®µ
- âœ… è™šæ‹Ÿå­—æ®µ JSON åºåˆ—åŒ–
- âœ… é™æ€é»˜è®¤å€¼
- âœ… å‡½æ•°é»˜è®¤å€¼
- âœ… ä¸Šä¸‹æ–‡é»˜è®¤å€¼
- âœ… é»˜è®¤å€¼ä¸è¦†ç›–å·²æä¾›å€¼
- âœ… insertMany é»˜è®¤å€¼
- âœ… è™šæ‹Ÿå­—æ®µ + é»˜è®¤å€¼ç»„åˆ

### æµ‹è¯•è¦†ç›–ç‡

**Model å±‚**:
- Statements: **92.85%** (221/238)
- Branches: **82.57%** (199/241)
- Functions: **92.59%** (25/27)
- Lines: **92.79%** (219/236)

**æ€»è®¡æµ‹è¯•**: 58 ä¸ªæµ‹è¯•ï¼Œ100% é€šè¿‡
- model-coverage-100.test.js: 13 ä¸ª
- model-populate-integration.test.js: 9 ä¸ª
- model-nested-populate.test.js: 5 ä¸ªï¼ˆæ–°å¢ï¼‰
- model-relations-edge-cases.test.js: 13 ä¸ªï¼ˆæ–°å¢ï¼‰
- model-populate-advanced.test.js: 8 ä¸ªï¼ˆæ–°å¢ï¼‰
- model-virtuals-defaults.test.js: 10 ä¸ªï¼ˆæ–°å¢ï¼‰

---

## æ–‡æ¡£æ”¹è¿› ğŸ“–

### æ–°å¢æ–‡æ¡£

1. **`docs/model/nested-populate.md`** - åµŒå¥— Populate å®Œæ•´æ–‡æ¡£
   - ä½¿ç”¨åœºæ™¯
   - é…ç½®é€‰é¡¹
   - æ€§èƒ½ä¼˜åŒ–å»ºè®®
   - å¸¸è§é—®é¢˜

2. **`reports/monSQLize/analysis/deep-analysis-v1.0.6.md`** - æ·±åº¦åˆ†ææŠ¥å‘Š
   - æ¶æ„åˆ†æ
   - åŠŸèƒ½å®Œæˆåº¦
   - æœªå®ŒæˆåŠŸèƒ½æ¸…å•
   - ä¼˜åŒ–å»ºè®®

### æ›´æ–°æ–‡æ¡£

1. **`docs/model/relations.md`** - Relations å’Œ Populate API æ–‡æ¡£ï¼ˆ753 è¡Œï¼‰
   - å®Œå–„ API å‚è€ƒ
   - æ·»åŠ æ›´å¤šç¤ºä¾‹
   - æ·»åŠ æœ€ä½³å®è·µ

2. **`docs/INDEX.md`** - æ·»åŠ  relations æ–‡æ¡£é“¾æ¥

3. **`index.d.ts`** - å®Œå–„ TypeScript ç±»å‹å®šä¹‰
   - æ–°å¢ `VirtualConfig` æ¥å£
   - æ–°å¢ `DefaultValue` ç±»å‹
   - æ›´æ–° `ModelDefinition` æ¥å£ï¼ˆvirtuals/defaultsï¼‰
   - ä¿®å¤ `RelationConfig` å®šä¹‰

---

## TypeScript æ”¯æŒå®Œå–„ âœ…

### ç±»å‹å®šä¹‰æ”¹è¿›

**Relations ç±»å‹ä¿®å¤**:
```typescript
// âŒ ä¿®å¤å‰ï¼šORM é£æ ¼ï¼ˆä¸ç¬¦åˆ MongoDB åŸç”Ÿï¼‰
interface RelationConfig {
    type: 'hasOne' | 'hasMany' | 'belongsTo';
    model: string;
    foreignKey: string;
}

// âœ… ä¿®å¤åï¼šMongoDB åŸç”Ÿé£æ ¼
interface RelationConfig {
    type: 'one' | 'many';
    ref: string;
    localField: string;
    foreignField: string;
}
```

**æ–°å¢ç±»å‹**:
```typescript
// è™šæ‹Ÿå­—æ®µé…ç½®
interface VirtualConfig {
    get: (this: any) => any;
    set?: (this: any, value: any) => void;
}

// é»˜è®¤å€¼ç±»å‹
type DefaultValue<T> = T | (() => T) | ((ctx: any) => T);

// Populate ä»£ç†æ¥å£
interface PopulateProxy<T = any> {
    populate(path: string | PopulateConfig): PopulateProxy<T>;
    exec(): Promise<T>;
}

// Populate é…ç½®æ¥å£
interface PopulateConfig {
    path: string;
    select?: string | string[];
    match?: any;
    sort?: any;
    limit?: number;
    skip?: number;
    populate?: string | PopulateConfig | PopulateConfig[];
}
```

**ModelInstance æ–¹æ³•è¿”å›ç±»å‹æ›´æ–°** (6ä¸ª):
- `find()` â†’ `PopulateProxy<T[]>`
- `findOne()` â†’ `PopulateProxy<T | null>`
- `findById()` â†’ `PopulateProxy<T | null>`
- `findByIds()` â†’ `PopulateProxy<T[]>`
- `findPage()` â†’ `PopulateProxy<PageResult<T>>`
- `findAndCount()` â†’ `PopulateProxy<{ rows: T[], count: number }>`

---

## å·²çŸ¥é—®é¢˜ âš ï¸

### å·²ä¿®å¤

- âœ… **TypeScript ç±»å‹å®šä¹‰å·²æ›´æ–°**ï¼šä¸å®é™…å®ç°å®Œå…¨åŒ¹é…
- âœ… **åµŒå¥— Populate é—®é¢˜å·²ä¿®å¤**ï¼šselect + populate ç»„åˆæ­£å¸¸å·¥ä½œ

### æŒç»­æ”¹è¿›

- âš ï¸ æ•´ä½“æµ‹è¯•è¦†ç›–ç‡ 71.48%ï¼Œåˆ†æ”¯è¦†ç›–ç‡ 61.66%ï¼ˆæŒç»­æ”¹è¿›ä¸­ï¼‰
- âœ… **å·²ç¡®è®¤**: è½¯åˆ é™¤å’Œä¹è§‚é”åŠŸèƒ½å·²å®Œæ•´å®ç°ï¼ˆè¦†ç›–ç‡ >97%ï¼‰

---

## ä½¿ç”¨å»ºè®® ğŸ’¡

### æ¨èå‡çº§

å¦‚æœä½ åœ¨ä½¿ç”¨åµŒå¥— populate æ—¶é‡åˆ°å…³è”æ•°æ®ä¸ºç©ºçš„é—®é¢˜ï¼Œ**å¼ºçƒˆå»ºè®®å‡çº§åˆ° v1.0.4**ã€‚

**å‡çº§å‘½ä»¤**:
```bash
npm install monsqlize@1.0.4
```

### ä½¿ç”¨è™šæ‹Ÿå­—æ®µ

è™šæ‹Ÿå­—æ®µé€‚ç”¨äºï¼š
- âœ… è®¡ç®—å±æ€§ï¼ˆå¦‚ fullName = firstName + lastNameï¼‰
- âœ… æ•°æ®æ ¼å¼åŒ–ï¼ˆå¦‚æ—¥æœŸæ ¼å¼åŒ–ã€è´§å¸æ ¼å¼åŒ–ï¼‰
- âœ… ä¸šåŠ¡é€»è¾‘å°è£…ï¼ˆå¦‚è®¢å•çŠ¶æ€æè¿°ï¼‰

**ä¸é€‚ç”¨äº**:
- âŒ éœ€è¦åœ¨æ•°æ®åº“æŸ¥è¯¢ä¸­ä½¿ç”¨çš„å­—æ®µ
- âŒ éœ€è¦æ’åº/ç­›é€‰çš„å­—æ®µ

### ä½¿ç”¨é»˜è®¤å€¼

é»˜è®¤å€¼é€‚ç”¨äºï¼š
- âœ… çŠ¶æ€å­—æ®µï¼ˆå¦‚ status: 'active'ï¼‰
- âœ… è®¡æ•°å™¨å­—æ®µï¼ˆå¦‚ score: 0ï¼‰
- âœ… æ—¶é—´æˆ³å­—æ®µï¼ˆå¦‚ createdAt: () => new Date()ï¼‰

**ä¸é€‚ç”¨äº**:
- âŒ å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼ˆä½¿ç”¨ hooks æ›´åˆé€‚ï¼‰
- âŒ ä¾èµ–å…¶ä»–å­—æ®µçš„è®¡ç®—ï¼ˆä½¿ç”¨ hooks æ›´åˆé€‚ï¼‰

---

## åç»­è®¡åˆ’ ğŸ—ºï¸

### v1.0.5ï¼ˆè®¡åˆ’ä¸­ï¼‰
- [ ] Schema éªŒè¯é»˜è®¤å¯ç”¨
- [ ] Model è‡ªåŠ¨åŠ è½½æœºåˆ¶
- [ ] è·¨æ•°æ®åº“ Model æ“ä½œ

### v1.1.0ï¼ˆè®¡åˆ’ä¸­ï¼‰
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ›´å¤šç¤ºä¾‹å’Œæœ€ä½³å®è·µ
- [ ] å®Œæ•´çš„è¿ç§»æŒ‡å—

---

**è·å–å¸®åŠ©**:
- ğŸ“– [å®Œæ•´æ–‡æ¡£](../docs/INDEX.md)
- ğŸ’¬ [GitHub Issues](https://github.com/vextjs/monSQLize/issues)

---

**æœ€åæ›´æ–°**: 2026-01-07

