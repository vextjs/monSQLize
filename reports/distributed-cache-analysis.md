# monSQLize åˆ†å¸ƒå¼ç¼“å­˜ä¸äº‹åŠ¡æœºåˆ¶åˆ†ææŠ¥å‘Š

**é¡¹ç›®**: monSQLize  
**åˆ†ææ—¥æœŸ**: 2025-11-25  
**åˆ†æèŒƒå›´**: åŒå±‚ç¼“å­˜ã€äº‹åŠ¡ç¼“å­˜åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„å·¥ä½œæœºåˆ¶

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

### æ ¸å¿ƒå‘ç°

1. âœ… **åŒå±‚ç¼“å­˜æ¶æ„å·²å®ç°** - æ”¯æŒæœ¬åœ°å†…å­˜ + Redis è¿œç«¯ç¼“å­˜
2. âš ï¸ **åˆ†å¸ƒå¼ç¼“å­˜å¤±æ•ˆæœºåˆ¶ä¸å®Œæ•´** - ç¼ºå°‘è·¨å®ä¾‹çš„ç¼“å­˜åŒæ­¥é€šçŸ¥
3. âœ… **äº‹åŠ¡ç¼“å­˜é”æœºåˆ¶å®Œå–„** - å•å®ä¾‹ä¸‹äº‹åŠ¡æœŸé—´ç¼“å­˜é”æœ‰æ•ˆ
4. âš ï¸ **åˆ†å¸ƒå¼äº‹åŠ¡ç¼“å­˜é”ç¼ºå¤±** - ç¼“å­˜é”ä»…åœ¨æœ¬åœ°ç”Ÿæ•ˆï¼Œæ— è·¨å®ä¾‹åè°ƒ
5. âš ï¸ **å¤šå®ä¾‹åœºæ™¯ä¸‹å­˜åœ¨ç¼“å­˜ä¸€è‡´æ€§é£é™©** - å†™æ“ä½œåå…¶ä»–å®ä¾‹å¯èƒ½è¯»åˆ°è„æ•°æ®

### é£é™©è¯„çº§

| åœºæ™¯ | é£é™©ç­‰çº§ | è¯´æ˜ |
|-----|---------|------|
| **å•å®ä¾‹éƒ¨ç½²** | ğŸŸ¢ ä½é£é™© | æ‰€æœ‰æœºåˆ¶å®Œå–„ï¼Œå¯å®‰å…¨ä½¿ç”¨ |
| **å¤šå®ä¾‹éƒ¨ç½² + æ—  Redis** | ğŸ”´ é«˜é£é™© | å„å®ä¾‹æœ¬åœ°ç¼“å­˜ç‹¬ç«‹ï¼Œå¼ºä¸€è‡´æ€§æ— ä¿éšœ |
| **å¤šå®ä¾‹éƒ¨ç½² + Redis** | ğŸŸ¡ ä¸­é£é™© | æœ‰è¿œç«¯ç¼“å­˜ä½†ç¼ºå°‘å¤±æ•ˆå¹¿æ’­ |
| **åˆ†å¸ƒå¼äº‹åŠ¡** | ğŸ”´ é«˜é£é™© | ç¼“å­˜é”ä»…æœ¬åœ°ç”Ÿæ•ˆ |

---

## ğŸ—ï¸ æ¶æ„åˆ†æ

### 1. åŒå±‚ç¼“å­˜æ¶æ„

#### 1.1 å®ç°æ¦‚è¿°

```javascript
// lib/multi-level-cache.js
class MultiLevelCache {
  constructor(options) {
    this.local = options.local;   // æœ¬åœ° LRU ç¼“å­˜
    this.remote = options.remote; // è¿œç«¯ Redisï¼ˆå¯é€‰ï¼‰
    this.policy = {
      writePolicy: 'both' | 'local-first-async-remote',
      backfillLocalOnRemoteHit: true
    };
  }
}
```

#### 1.2 è¯»å–æµç¨‹

```
ç”¨æˆ·æŸ¥è¯¢
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æœ¬åœ°ç¼“å­˜æŸ¥è¯¢  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ å‘½ä¸­ âœ“ â†’ è¿”å›æ•°æ®
       â”‚ æœªå‘½ä¸­ âœ—
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è¿œç«¯ç¼“å­˜æŸ¥è¯¢  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ å‘½ä¸­ âœ“ â†’ å›å¡«æœ¬åœ° â†’ è¿”å›æ•°æ®
       â”‚ æœªå‘½ä¸­ âœ—
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æŸ¥è¯¢æ•°æ®åº“    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
   å†™å…¥ç¼“å­˜
  ï¼ˆæœ¬åœ° + è¿œç«¯ï¼‰
```

#### 1.3 å†™å…¥ç­–ç•¥

**ç­–ç•¥ 1: åŒå†™ï¼ˆbothï¼‰**
```javascript
async set(key, val, ttl) {
  await this.local.set(key, val, ttl);  // åŒæ­¥å†™æœ¬åœ°
  await this.remote.set(key, val, ttl); // åŒæ­¥å†™è¿œç«¯
}
```
- âœ… ä¼˜ç‚¹ï¼šæ•°æ®ä¸€è‡´æ€§å¼º
- âŒ ç¼ºç‚¹ï¼šå»¶è¿Ÿè¾ƒé«˜ï¼ˆç­‰å¾… Redis å“åº”ï¼‰

**ç­–ç•¥ 2: æœ¬åœ°ä¼˜å…ˆï¼ˆlocal-first-async-remoteï¼‰**
```javascript
async set(key, val, ttl) {
  await this.local.set(key, val, ttl);  // åŒæ­¥å†™æœ¬åœ°
  this.remote.set(key, val, ttl).catch(() => {}); // å¼‚æ­¥å†™è¿œç«¯
}
```
- âœ… ä¼˜ç‚¹ï¼šå“åº”å¿«
- âŒ ç¼ºç‚¹ï¼šçŸ­æœŸå†…æœ¬åœ°å’Œè¿œç«¯å¯èƒ½ä¸ä¸€è‡´

---

### 2. äº‹åŠ¡ç¼“å­˜æœºåˆ¶

#### 2.1 ç¼“å­˜é”ç®¡ç†å™¨ï¼ˆCacheLockManagerï¼‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼šé˜²æ­¢äº‹åŠ¡æœŸé—´è„æ•°æ®å†™å…¥ç¼“å­˜

```javascript
// lib/transaction/CacheLockManager.js
class CacheLockManager {
  constructor(options) {
    this.locks = new Map(); // key -> { sessionId, expiresAt }
  }

  addLock(key, session) {
    this.locks.set(key, {
      sessionId: session.id.toString(),
      expiresAt: Date.now() + this.maxDuration
    });
  }

  isLocked(key) {
    // æ£€æŸ¥ç²¾ç¡®åŒ¹é… + é€šé…ç¬¦åŒ¹é…
  }

  releaseLocks(session) {
    // é‡Šæ”¾æŒ‡å®š session çš„æ‰€æœ‰é”
  }
}
```

#### 2.2 ç¼“å­˜é”å·¥ä½œæµç¨‹

```
äº‹åŠ¡å¼€å§‹ (tx.start())
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. é”å®šç›¸å…³ç¼“å­˜é”®            â”‚
â”‚    lockManager.addLock()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ‰§è¡Œæ•°æ®åº“æ“ä½œ            â”‚
â”‚    (session ä¼ é€’ç»™æ‰€æœ‰æ“ä½œ)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æäº¤/å›æ»š                 â”‚
â”‚    tx.commit() / tx.abort()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. é‡Šæ”¾ç¼“å­˜é”                â”‚
â”‚    lockManager.releaseLocks()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.3 ç¼“å­˜å†™å…¥æ‹¦æˆª

```javascript
// lib/cache.js
async set(key, value, ttl = 0) {
  // æ£€æŸ¥ç¼“å­˜é”ï¼šå¦‚æœè¯¥é”®è¢«é”å®šï¼Œæ‹’ç»å†™å…¥
  if (this.lockManager && this.lockManager.isLocked(key)) {
    return; // âš ï¸ è·³è¿‡å†™å…¥ï¼Œé˜²æ­¢è„æ•°æ®
  }
  
  // æ­£å¸¸å†™å…¥æµç¨‹...
}
```

---

## ğŸ” åˆ†å¸ƒå¼åœºæ™¯åˆ†æ

### åœºæ™¯ 1: å•å®ä¾‹éƒ¨ç½²ï¼ˆâœ… å®‰å…¨ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Node.js å®ä¾‹               â”‚
â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ æœ¬åœ°ç¼“å­˜ LRU  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚          â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ CacheLock     â”‚          â”‚
â”‚  â”‚ Manager       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    MongoDB (å‰¯æœ¬é›†)
```

**å·¥ä½œæœºåˆ¶**ï¼š
- âœ… äº‹åŠ¡é”åœ¨æœ¬åœ°ç”Ÿæ•ˆï¼Œé˜²æ­¢è„æ•°æ®å†™å…¥
- âœ… ç¼“å­˜å¤±æ•ˆæœºåˆ¶ç›´æ¥ä½œç”¨äºæœ¬åœ°ç¼“å­˜
- âœ… æ— è·¨å®ä¾‹ä¸€è‡´æ€§é—®é¢˜

**é€‚ç”¨åœºæ™¯**ï¼š
- å°å‹åº”ç”¨
- å¼€å‘/æµ‹è¯•ç¯å¢ƒ
- æµé‡ä¸å¤§çš„ç”Ÿäº§ç¯å¢ƒ

---

### åœºæ™¯ 2: å¤šå®ä¾‹ + ç‹¬ç«‹æœ¬åœ°ç¼“å­˜ï¼ˆğŸ”´ é«˜é£é™©ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®ä¾‹ A           â”‚    â”‚  å®ä¾‹ B           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚æœ¬åœ°ç¼“å­˜A â”‚      â”‚    â”‚ â”‚æœ¬åœ°ç¼“å­˜B â”‚      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
             MongoDB (å‰¯æœ¬é›†)
```

**é—®é¢˜åˆ†æ**ï¼š

**é—®é¢˜ 1: ç¼“å­˜å¤±æ•ˆä¸åŒæ­¥**
```javascript
// æ—¶é—´çº¿
T1: å®ä¾‹ A æŸ¥è¯¢ç”¨æˆ· { id: 1, balance: 100 } â†’ å†™å…¥æœ¬åœ°ç¼“å­˜A
T2: å®ä¾‹ B æŸ¥è¯¢ç”¨æˆ· { id: 1, balance: 100 } â†’ å†™å…¥æœ¬åœ°ç¼“å­˜B
T3: å®ä¾‹ A æ›´æ–°ä½™é¢ä¸º 150 â†’ å¤±æ•ˆæœ¬åœ°ç¼“å­˜A âœ“
T4: å®ä¾‹ B æŸ¥è¯¢ç”¨æˆ· â†’ å‘½ä¸­æœ¬åœ°ç¼“å­˜B â†’ è¿”å›æ—§æ•°æ® 100 âŒ
```

**é—®é¢˜ 2: äº‹åŠ¡ç¼“å­˜é”ä¸ç”Ÿæ•ˆ**
```javascript
// æ—¶é—´çº¿
T1: å®ä¾‹ A å¼€å¯äº‹åŠ¡ï¼Œé”å®šç¼“å­˜é”® "user:1" (ä»…æœ¬åœ°é”)
T2: å®ä¾‹ A åœ¨äº‹åŠ¡ä¸­æ›´æ–°ç”¨æˆ·ä½™é¢ (æœªæäº¤)
T3: å®ä¾‹ B æŸ¥è¯¢ç”¨æˆ· â†’ ä»æ•°æ®åº“è¯»åˆ°æ—§æ•°æ® â†’ å†™å…¥æœ¬åœ°ç¼“å­˜B âŒ
T4: å®ä¾‹ A æäº¤äº‹åŠ¡ â†’ é‡Šæ”¾æœ¬åœ°é”ï¼Œå¤±æ•ˆæœ¬åœ°ç¼“å­˜A
T5: å®ä¾‹ B ç¼“å­˜ä»ç„¶æ˜¯è„æ•°æ®
```

**é£é™©ç­‰çº§**ï¼šğŸ”´ é«˜é£é™©
- ç¼“å­˜ä¸æ•°æ®åº“ä¸ä¸€è‡´
- äº‹åŠ¡éš”ç¦»æ€§è¢«ç ´å
- ä¸šåŠ¡é€»è¾‘å¯èƒ½å‡ºé”™ï¼ˆå¦‚ä½™é¢è®¡ç®—ï¼‰

---

### åœºæ™¯ 3: å¤šå®ä¾‹ + Redis è¿œç«¯ç¼“å­˜ï¼ˆğŸŸ¡ ä¸­é£é™©ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®ä¾‹ A           â”‚    â”‚  å®ä¾‹ B           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚æœ¬åœ°ç¼“å­˜A â”‚      â”‚    â”‚ â”‚æœ¬åœ°ç¼“å­˜B â”‚      â”‚
â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚    â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                         â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Redis     â”‚
         â”‚ (è¿œç«¯ç¼“å­˜)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
           MongoDB (å‰¯æœ¬é›†)
```

**æ”¹å–„ç‚¹**ï¼š
- âœ… Redis ä½œä¸ºå…±äº«ç¼“å­˜å±‚ï¼Œå‡å°‘æ•°æ®åº“è®¿é—®
- âœ… è¿œç«¯ç¼“å­˜å¤±æ•ˆå¯¹æ‰€æœ‰å®ä¾‹ç”Ÿæ•ˆ

**ä»å­˜åœ¨é—®é¢˜**ï¼š

**é—®é¢˜ 1: æœ¬åœ°ç¼“å­˜å¤±æ•ˆä¸åŒæ­¥**
```javascript
// æ—¶é—´çº¿
T1: å®ä¾‹ A æŸ¥è¯¢ç”¨æˆ· â†’ æœ¬åœ°ç¼“å­˜A + Redis éƒ½ç¼“å­˜
T2: å®ä¾‹ B æŸ¥è¯¢ç”¨æˆ· â†’ æœ¬åœ°ç¼“å­˜B ç¼“å­˜ï¼ˆRedis å‘½ä¸­å›å¡«ï¼‰
T3: å®ä¾‹ A æ›´æ–°ç”¨æˆ· â†’ å¤±æ•ˆæœ¬åœ°ç¼“å­˜A + Redis âœ“
T4: å®ä¾‹ B æŸ¥è¯¢ç”¨æˆ· â†’ å‘½ä¸­æœ¬åœ°ç¼“å­˜B â†’ è¿”å›è„æ•°æ® âŒ
```

**é—®é¢˜ 2: äº‹åŠ¡æœŸé—´ç¼“å­˜å†™å…¥ç«æ€**
```javascript
// æ—¶é—´çº¿
T1: å®ä¾‹ A å¼€å¯äº‹åŠ¡ï¼Œé”å®šæœ¬åœ°ç¼“å­˜é”® "user:1"
T2: å®ä¾‹ A åœ¨äº‹åŠ¡ä¸­æ›´æ–°æ•°æ®ï¼ˆæœªæäº¤ï¼‰
T3: å®ä¾‹ B æŸ¥è¯¢ç”¨æˆ· â†’ Redis miss â†’ è¯»æ•°æ®åº“ â†’ å†™å…¥ Redis âŒ
T4: å®ä¾‹ A æäº¤äº‹åŠ¡ï¼Œå¤±æ•ˆ Redis
T5: çŸ­æš‚çª—å£å†…ï¼ŒRedis å¯èƒ½æœ‰è„æ•°æ®
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­é£é™©
- Redis å±‚ä¸€è‡´æ€§è¾ƒå¥½
- æœ¬åœ°ç¼“å­˜ä»æœ‰çŸ­æœŸä¸ä¸€è‡´
- äº‹åŠ¡éš”ç¦»æ€§éƒ¨åˆ†å—æŸ

**é€‚ç”¨åœºæ™¯**ï¼š
- å¯ä»¥å®¹å¿çŸ­æœŸï¼ˆç§’çº§ï¼‰æ•°æ®ä¸ä¸€è‡´
- éå¼ºä¸€è‡´æ€§è¦æ±‚çš„ä¸šåŠ¡ï¼ˆå¦‚å•†å“åˆ—è¡¨ã€æ¨èå†…å®¹ï¼‰

---

### åœºæ™¯ 4: åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯ï¼ˆğŸ”´ é«˜é£é™©ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®ä¾‹ A (äº‹åŠ¡åè°ƒè€…)                  â”‚
â”‚                                       â”‚
â”‚  withTransaction(async (tx) => {     â”‚
â”‚    // sessionId: abc123              â”‚
â”‚    await updateUser({ session })     â”‚
â”‚    await updateOrder({ session })    â”‚
â”‚  })                                  â”‚
â”‚                                       â”‚
â”‚  CacheLockManager: {                 â”‚
â”‚    locks: Map {                      â”‚
â”‚      "user:1" -> { sessionId: abc123}â”‚
â”‚      "order:1" -> { sessionId: abc123}â”‚
â”‚    }                                 â”‚
â”‚  }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         MongoDB (å‰¯æœ¬é›†)
                â–²
                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®ä¾‹ B (è¯»å–èŠ‚ç‚¹)                    â”‚
â”‚                                       â”‚
â”‚  // æŸ¥è¯¢ç”¨æˆ·                          â”‚
â”‚  await findOne({ _id: 1 })           â”‚
â”‚  â†’ è¯»åˆ°äº‹åŠ¡ä¸­çš„æ•°æ® âŒ                â”‚
â”‚  â†’ å†™å…¥æœ¬åœ°ç¼“å­˜ âŒ                    â”‚
â”‚                                       â”‚
â”‚  CacheLockManager: {                 â”‚
â”‚    locks: Map {} // ç©ºï¼              â”‚
â”‚  }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒé—®é¢˜**ï¼š
1. âŒ **CacheLockManager ä»…åœ¨æœ¬åœ°ç”Ÿæ•ˆ**
2. âŒ **å…¶ä»–å®ä¾‹ä¸çŸ¥é“äº‹åŠ¡æ­£åœ¨è¿›è¡Œ**
3. âŒ **MongoDB äº‹åŠ¡çš„éš”ç¦»çº§åˆ«å¯èƒ½å…è®¸è¯»åˆ°æœªæäº¤æ•°æ®**

**å®é™…åæœ**ï¼š
```javascript
// å®ä¾‹ A: è½¬è´¦äº‹åŠ¡
await msq.withTransaction(async (tx) => {
  // æ‰£æ¬¾ Alice
  await accounts.updateOne(
    { userId: 'alice' },
    { $inc: { balance: -100 } },
    { session: tx.session }
  );
  
  // å®ä¾‹ B æ­¤æ—¶æŸ¥è¯¢ Alice ä½™é¢
  // â†’ å¯èƒ½è¯»åˆ°ä¸­é—´çŠ¶æ€
  // â†’ å†™å…¥ç¼“å­˜
  
  // åŠ æ¬¾ Bob
  await accounts.updateOne(
    { userId: 'bob' },
    { $inc: { balance: 100 } },
    { session: tx.session }
  );
});
```

**é£é™©ç­‰çº§**ï¼šğŸ”´ é«˜é£é™©
- äº‹åŠ¡éš”ç¦»æ€§å®Œå…¨å¤±æ•ˆ
- å¯èƒ½è¯»åˆ°ä¸­é—´çŠ¶æ€
- é‡‘èã€äº¤æ˜“ç±»ä¸šåŠ¡ä¸å¯æ¥å—

---

## ğŸš¨ å·²è¯†åˆ«çš„é—®é¢˜æ¸…å•

### P0 çº§åˆ«é—®é¢˜ï¼ˆä¸¥é‡ï¼‰

#### é—®é¢˜ 1: ç¼ºå°‘åˆ†å¸ƒå¼ç¼“å­˜å¤±æ•ˆå¹¿æ’­æœºåˆ¶
**å½±å“**ï¼šå†™æ“ä½œåå…¶ä»–å®ä¾‹çš„æœ¬åœ°ç¼“å­˜ä¸å¤±æ•ˆ  
**åœºæ™¯**ï¼šå¤šå®ä¾‹ + æœ¬åœ°ç¼“å­˜  
**ä»£ç ä½ç½®**ï¼š`lib/multi-level-cache.js`

```javascript
// å½“å‰å®ç°
async delPattern(pattern) {
  const deleted = await this.local.delPattern(pattern);
  // âš ï¸ ä»…å‘é›†ç¾¤å¹¿æ’­ï¼Œä½†å®é™…æ²¡æœ‰æ¥æ”¶å’Œå¤„ç†æœºåˆ¶
  try { 
    if (this.publish) this.publish({ 
      type: 'invalidate', 
      pattern, 
      ts: Date.now() 
    }); 
  } catch(_) {}
  return deleted;
}
```

**é—®é¢˜**ï¼š
- `publish` å‡½æ•°å­˜åœ¨ä½†æ— é…å¥—çš„è®¢é˜…å¤„ç†
- å…¶ä»–å®ä¾‹ä¸ä¼šæ”¶åˆ°å¤±æ•ˆé€šçŸ¥
- åªæ˜¯ä¸€ä¸ª"é¢„ç•™æ¥å£"ï¼ŒæœªçœŸæ­£å®ç°

#### é—®é¢˜ 2: äº‹åŠ¡ç¼“å­˜é”æ— åˆ†å¸ƒå¼æ”¯æŒ
**å½±å“**ï¼šåˆ†å¸ƒå¼ç¯å¢ƒä¸‹äº‹åŠ¡éš”ç¦»æ€§å¤±æ•ˆ  
**åœºæ™¯**ï¼šå¤šå®ä¾‹ + äº‹åŠ¡  
**ä»£ç ä½ç½®**ï¼š`lib/transaction/CacheLockManager.js`

```javascript
// å½“å‰å®ç°
class CacheLockManager {
  constructor(options) {
    this.locks = new Map(); // âš ï¸ æœ¬åœ° Mapï¼Œæ— è·¨å®ä¾‹å…±äº«
  }
  
  isLocked(key) {
    // âš ï¸ ä»…æ£€æŸ¥æœ¬åœ°é”
    if (this.locks.has(key)) {
      // ...
    }
  }
}
```

**é—®é¢˜**ï¼š
- é”ä¿¡æ¯å­˜å‚¨åœ¨æœ¬åœ°å†…å­˜
- å…¶ä»–å®ä¾‹å®Œå…¨ä¸çŸ¥é“é”çš„å­˜åœ¨
- äº‹åŠ¡æœŸé—´å…¶ä»–å®ä¾‹å¯èƒ½å†™å…¥è„æ•°æ®

---

### P1 çº§åˆ«é—®é¢˜ï¼ˆé‡è¦ï¼‰

#### é—®é¢˜ 3: Redis ç¼“å­˜å¤±æ•ˆæ—  TTL ç²¾ç¡®å›å¡«
**å½±å“**ï¼šæœ¬åœ°ç¼“å­˜å›å¡«æ—¶ä¸¢å¤±åŸå§‹ TTL ä¿¡æ¯  
**åœºæ™¯**ï¼šå¤šå±‚ç¼“å­˜ + è¿œç«¯å‘½ä¸­  
**ä»£ç ä½ç½®**ï¼š`lib/multi-level-cache.js`

```javascript
async get(key) {
  const v = await this.local.get(key);
  if (v !== undefined) return v;
  
  try {
    const r = await this._withTimeout(this.remote.get(key));
    if (r !== undefined && this.policy.backfillLocalOnRemoteHit) {
      // âš ï¸ æ— æ³•è·å–åŸå§‹ TTLï¼Œç›´æ¥è®¾ç½®æ— è¿‡æœŸæ—¶é—´
      await this.local.set(key, r); // ç¼ºå°‘ ttl å‚æ•°
    }
    return r;
  } catch(_) {
    return undefined;
  }
}
```

#### é—®é¢˜ 4: ç¼ºå°‘åˆ†å¸ƒå¼ç¯å¢ƒçš„ä½¿ç”¨æ–‡æ¡£
**å½±å“**ï¼šç”¨æˆ·ä¸äº†è§£åˆ†å¸ƒå¼åœºæ™¯ä¸‹çš„é™åˆ¶å’Œé£é™©  
**ä½ç½®**ï¼šæ–‡æ¡£ç¼ºå¤±

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆå»ºè®®

### æ–¹æ¡ˆ 1: åŸºäº Redis Pub/Sub çš„ç¼“å­˜å¤±æ•ˆå¹¿æ’­ï¼ˆæ¨èï¼‰

**æ¶æ„å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®ä¾‹ A      â”‚         â”‚  å®ä¾‹ B      â”‚
â”‚              â”‚         â”‚              â”‚
â”‚ 1.å†™å…¥æ•°æ®   â”‚         â”‚              â”‚
â”‚ 2.å¤±æ•ˆç¼“å­˜   â”‚         â”‚              â”‚
â”‚ 3.å‘å¸ƒæ¶ˆæ¯   â”‚         â”‚              â”‚
â”‚     â”‚        â”‚         â”‚              â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”   â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚    Redis    â”‚
             â”‚  Pub/Sub    â”‚
             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ å¹¿æ’­å¤±æ•ˆæ¶ˆæ¯         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®ä¾‹ A      â”‚         â”‚  å®ä¾‹ B      â”‚
â”‚ 4.æ”¶åˆ°æ¶ˆæ¯   â”‚         â”‚ 4.æ”¶åˆ°æ¶ˆæ¯   â”‚
â”‚ 5.å¤±æ•ˆç¼“å­˜   â”‚         â”‚ 5.å¤±æ•ˆç¼“å­˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ä»£ç **ï¼š

```javascript
// lib/distributed-cache-invalidator.js (æ–°æ–‡ä»¶)
const Redis = require('ioredis');

class DistributedCacheInvalidator {
  constructor(options) {
    const redisUrl = options.redisUrl || 'redis://localhost:6379';
    this.pub = new Redis(redisUrl);
    this.sub = new Redis(redisUrl);
    this.channel = options.channel || 'monsqlize:cache:invalidate';
    this.instanceId = options.instanceId || `instance-${Date.now()}-${Math.random()}`;
    this.cache = options.cache; // MultiLevelCache å®ä¾‹
    
    this._setupSubscription();
  }
  
  _setupSubscription() {
    this.sub.subscribe(this.channel);
    this.sub.on('message', (channel, message) => {
      if (channel !== this.channel) return;
      
      try {
        const data = JSON.parse(message);
        
        // å¿½ç•¥è‡ªå·±å‘é€çš„æ¶ˆæ¯
        if (data.instanceId === this.instanceId) return;
        
        // å¤±æ•ˆæœ¬åœ°ç¼“å­˜
        if (data.type === 'invalidate' && data.pattern) {
          this.cache.local.delPattern(data.pattern);
        }
      } catch (error) {
        // å¿½ç•¥è§£æé”™è¯¯
      }
    });
  }
  
  /**
   * å¹¿æ’­ç¼“å­˜å¤±æ•ˆæ¶ˆæ¯
   * @param {string} pattern - ç¼“å­˜é”®æ¨¡å¼ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
   */
  async invalidate(pattern) {
    const message = JSON.stringify({
      type: 'invalidate',
      pattern,
      instanceId: this.instanceId,
      ts: Date.now()
    });
    
    await this.pub.publish(this.channel, message);
  }
  
  async close() {
    await this.pub.quit();
    await this.sub.quit();
  }
}

module.exports = DistributedCacheInvalidator;
```

**é›†æˆåˆ° MonSQLize**ï¼š

```javascript
// lib/index.js (ä¿®æ”¹)
class MonSQLize {
  constructor(options) {
    // ...ç°æœ‰ä»£ç 
    
    // åˆå§‹åŒ–åˆ†å¸ƒå¼ç¼“å­˜å¤±æ•ˆå™¨
    if (options.cache?.distributed) {
      const DistributedCacheInvalidator = require('./distributed-cache-invalidator');
      this.cacheInvalidator = new DistributedCacheInvalidator({
        redisUrl: options.cache.distributed.redisUrl,
        channel: options.cache.distributed.channel,
        cache: this.cache
      });
    }
  }
  
  async _invalidateCache(pattern) {
    // å¤±æ•ˆæœ¬åœ° + Redis
    await this.cache.delPattern(pattern);
    
    // å¹¿æ’­ç»™å…¶ä»–å®ä¾‹
    if (this.cacheInvalidator) {
      await this.cacheInvalidator.invalidate(pattern);
    }
  }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```javascript
const msq = new MonSQLize({
  type: 'mongodb',
  databaseName: 'mydb',
  config: { uri: 'mongodb://localhost:27017' },
  
  cache: {
    multiLevel: true,
    local: { maxSize: 1000 },
    remote: MonSQLize.createRedisCacheAdapter('redis://localhost:6379/0'),
    
    // ğŸ†• å¯ç”¨åˆ†å¸ƒå¼ç¼“å­˜å¤±æ•ˆ
    distributed: {
      redisUrl: 'redis://localhost:6379',
      channel: 'monsqlize:cache:invalidate' // è‡ªå®šä¹‰é¢‘é“
    }
  }
});
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®æ—¶å¹¿æ’­ï¼Œå»¶è¿Ÿä½ï¼ˆæ¯«ç§’çº§ï¼‰
- âœ… ä½¿ç”¨ Redis ç°æœ‰åŸºç¡€è®¾æ–½
- âœ… å®ç°ç®€å•ï¼Œæ˜“äºç»´æŠ¤
- âœ… æ”¯æŒæ¨¡å¼åŒ¹é…å¤±æ•ˆ

**ç¼ºç‚¹**ï¼š
- âš ï¸ ä¾èµ– Redis
- âš ï¸ æçŸ­æ—¶é—´çª—å£å†…å¯èƒ½ä¸ä¸€è‡´ï¼ˆç½‘ç»œå»¶è¿Ÿï¼‰

---

### æ–¹æ¡ˆ 2: åŸºäº Redis çš„åˆ†å¸ƒå¼äº‹åŠ¡é”ï¼ˆæ¨èï¼‰

**å®ç°åŸç†**ï¼šä½¿ç”¨ Redis å­˜å‚¨äº‹åŠ¡é”ä¿¡æ¯

```javascript
// lib/transaction/DistributedCacheLockManager.js (æ–°æ–‡ä»¶)
const Redis = require('ioredis');

class DistributedCacheLockManager {
  constructor(options) {
    this.redis = options.redis; // ioredis å®ä¾‹
    this.lockKeyPrefix = options.lockKeyPrefix || 'monsqlize:cache:lock:';
    this.maxDuration = options.maxDuration || 300000; // 5 åˆ†é’Ÿ
  }
  
  /**
   * æ·»åŠ åˆ†å¸ƒå¼ç¼“å­˜é”
   * @param {string} key - ç¼“å­˜é”®
   * @param {Object} session - MongoDB session
   */
  async addLock(key, session) {
    if (!session || !session.id) return;
    
    const lockKey = this.lockKeyPrefix + key;
    const sessionId = session.id.toString();
    const ttl = Math.ceil(this.maxDuration / 1000); // è½¬ä¸ºç§’
    
    // ä½¿ç”¨ SET NX EX åŸå­æ“ä½œ
    await this.redis.set(lockKey, sessionId, 'EX', ttl, 'NX');
  }
  
  /**
   * æ£€æŸ¥ç¼“å­˜é”®æ˜¯å¦è¢«é”å®šï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
   * @param {string} key - ç¼“å­˜é”®
   * @returns {Promise<boolean>}
   */
  async isLocked(key) {
    // ç²¾ç¡®åŒ¹é…
    const lockKey = this.lockKeyPrefix + key;
    const exists = await this.redis.exists(lockKey);
    if (exists) return true;
    
    // é€šé…ç¬¦åŒ¹é…ï¼ˆæ€§èƒ½è€ƒè™‘ï¼šä»…æ£€æŸ¥å¸¸è§æ¨¡å¼ï¼‰
    // ä¾‹å¦‚ï¼šuser:* é”å®šæ‰€æœ‰ user: å¼€å¤´çš„é”®
    const pattern = this.lockKeyPrefix + '*';
    const keys = await this.redis.keys(pattern);
    
    for (const lockKey of keys) {
      const lockPattern = lockKey.replace(this.lockKeyPrefix, '');
      if (lockPattern.includes('*')) {
        const regex = new RegExp('^' + lockPattern.replace(/\*/g, '.*') + '$');
        if (regex.test(key)) {
          return true;
        }
      }
    }
    
    return false;
  }
  
  /**
   * é‡Šæ”¾æŒ‡å®š session çš„æ‰€æœ‰é”
   * @param {Object} session - MongoDB session
   */
  async releaseLocks(session) {
    if (!session || !session.id) return;
    
    const sessionId = session.id.toString();
    const pattern = this.lockKeyPrefix + '*';
    const keys = await this.redis.keys(pattern);
    
    // ä½¿ç”¨ Lua è„šæœ¬æ‰¹é‡åˆ é™¤ï¼ˆåŸå­æ“ä½œï¼‰
    if (keys.length > 0) {
      const lua = `
        local keys = KEYS
        local sessionId = ARGV[1]
        local deleted = 0
        for i, key in ipairs(keys) do
          if redis.call('get', key) == sessionId then
            redis.call('del', key)
            deleted = deleted + 1
          end
        end
        return deleted
      `;
      await this.redis.eval(lua, keys.length, ...keys, sessionId);
    }
  }
  
  /**
   * æ¸…ç†æ‰€æœ‰è¿‡æœŸé”ï¼ˆå®šæœŸæ‰§è¡Œï¼‰
   */
  async cleanup() {
    // Redis TTL ä¼šè‡ªåŠ¨æ¸…ç†ï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç†
  }
}

module.exports = DistributedCacheLockManager;
```

**é›†æˆåˆ°äº‹åŠ¡ç®¡ç†å™¨**ï¼š

```javascript
// lib/transaction/TransactionManager.js (ä¿®æ”¹)
class TransactionManager {
  constructor(adapter, cache, logger, options = {}) {
    // ...ç°æœ‰ä»£ç 
    
    // æ ¹æ®é…ç½®é€‰æ‹©é”ç®¡ç†å™¨
    if (options.distributedLock && options.distributedLock.redis) {
      const DistributedCacheLockManager = require('./DistributedCacheLockManager');
      this.lockManager = new DistributedCacheLockManager({
        redis: options.distributedLock.redis,
        lockKeyPrefix: options.distributedLock.keyPrefix,
        maxDuration: options.lockMaxDuration || 300000
      });
    } else {
      // ä½¿ç”¨æœ¬åœ°é”ç®¡ç†å™¨
      this.lockManager = new CacheLockManager({
        logger: this.logger,
        maxDuration: options.lockMaxDuration || 300000,
        cleanupInterval: options.lockCleanupInterval || 10000
      });
    }
    
    // è®¾ç½®åˆ°ç¼“å­˜
    if (cache && typeof cache.setLockManager === 'function') {
      cache.setLockManager(this.lockManager);
    }
  }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```javascript
const Redis = require('ioredis');
const redis = new Redis('redis://localhost:6379');

const msq = new MonSQLize({
  type: 'mongodb',
  databaseName: 'mydb',
  config: { uri: 'mongodb://localhost:27017?replicaSet=rs0' },
  
  transaction: {
    // ğŸ†• å¯ç”¨åˆ†å¸ƒå¼äº‹åŠ¡é”
    distributedLock: {
      redis: redis, // ä¼ å…¥ Redis å®ä¾‹
      keyPrefix: 'monsqlize:cache:lock:'
    }
  }
});
```

**ä¼˜ç‚¹**ï¼š
- âœ… çœŸæ­£çš„åˆ†å¸ƒå¼é”
- âœ… æ‰€æœ‰å®ä¾‹å…±äº«é”çŠ¶æ€
- âœ… äº‹åŠ¡éš”ç¦»æ€§å¾—åˆ°ä¿éšœ
- âœ… Redis è‡ªåŠ¨ TTL æ¸…ç†

**ç¼ºç‚¹**ï¼š
- âš ï¸ æ€§èƒ½ç•¥æœ‰ä¸‹é™ï¼ˆRedis ç½‘ç»œè¯·æ±‚ï¼‰
- âš ï¸ ä¾èµ– Redis å¯ç”¨æ€§

---

### æ–¹æ¡ˆ 3: é™çº§æ–¹æ¡ˆ - ç¦ç”¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ç¼“å­˜

**é€‚ç”¨åœºæ™¯**ï¼š
- æ— æ³•ä½¿ç”¨ Redis
- å¼ºä¸€è‡´æ€§è¦æ±‚
- ç®€åŒ–éƒ¨ç½²

**å®ç°ä»£ç **ï¼š

```javascript
// é…ç½®é€‰é¡¹
const msq = new MonSQLize({
  type: 'mongodb',
  databaseName: 'mydb',
  config: { uri: 'mongodb://localhost:27017' },
  
  cache: {
    // ğŸ†• åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ç¦ç”¨ç¼“å­˜
    disableInDistributed: true,
    
    // æˆ–ä»…åœ¨äº‹åŠ¡ä¸­ç¦ç”¨ç¼“å­˜ï¼ˆå·²å®ç°ï¼‰
    // äº‹åŠ¡å†…é»˜è®¤ä¸ä½¿ç”¨ç¼“å­˜
  }
});
```

**æ£€æµ‹é€»è¾‘**ï¼š

```javascript
// lib/index.js (æ–°å¢)
_isDistributedEnvironment() {
  // æ£€æµ‹ç¯å¢ƒå˜é‡
  const nodeEnv = process.env.NODE_ENV;
  const instanceId = process.env.INSTANCE_ID;
  const podName = process.env.POD_NAME; // K8s
  
  // å¦‚æœè®¾ç½®äº†å®ä¾‹æ ‡è¯†ï¼Œè®¤ä¸ºæ˜¯åˆ†å¸ƒå¼ç¯å¢ƒ
  return !!(instanceId || podName);
}

_shouldUseCache(options) {
  if (this.options.cache?.disableInDistributed && this._isDistributedEnvironment()) {
    return false;
  }
  return options.cache > 0;
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… 100% æ•°æ®ä¸€è‡´æ€§
- âœ… æ— å¤–éƒ¨ä¾èµ–
- âœ… å®ç°ç®€å•

**ç¼ºç‚¹**ï¼š
- âŒ æ€§èƒ½ä¸‹é™ï¼ˆæ‰€æœ‰è¯·æ±‚æŸ¥æ•°æ®åº“ï¼‰
- âŒ æ•°æ®åº“å‹åŠ›å¢å¤§

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¸€è‡´æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | Redis ä¾èµ– | æ¨èåœºæ™¯ |
|-----|-------|------|--------|-----------|---------|
| **Pub/Sub å¹¿æ’­** | ğŸŸ¡ æœ€ç»ˆä¸€è‡´ | ğŸŸ¢ é«˜ | ğŸŸ¡ ä¸­ | âœ… æ˜¯ | é€šç”¨æ¨è |
| **åˆ†å¸ƒå¼äº‹åŠ¡é”** | ğŸŸ¢ å¼ºä¸€è‡´ | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | âœ… æ˜¯ | é‡‘è/äº¤æ˜“ |
| **ç¦ç”¨ç¼“å­˜** | ğŸŸ¢ å¼ºä¸€è‡´ | ğŸ”´ ä½ | ğŸŸ¢ ä½ | âŒ å¦ | å°æµé‡/å¼ºä¸€è‡´ |
| **ä»…æœ¬åœ°ç¼“å­˜** | ğŸŸ¡ æœ€ç»ˆä¸€è‡´ | ğŸŸ¢ é«˜ | ğŸŸ¢ ä½ | âŒ å¦ | å•å®ä¾‹ |

---

## ğŸ”§ å®æ–½å»ºè®®

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰

1. **æ·»åŠ æ–‡æ¡£è­¦å‘Š**
   - åœ¨ `docs/cache.md` ä¸­æ·»åŠ åˆ†å¸ƒå¼ç¯å¢ƒé™åˆ¶è¯´æ˜
   - åœ¨ `docs/transaction.md` ä¸­è¯´æ˜ç¼“å­˜é”çš„ä½œç”¨èŒƒå›´

2. **å®ç° Pub/Sub ç¼“å­˜å¤±æ•ˆ**
   - å®ç° `DistributedCacheInvalidator`
   - é›†æˆåˆ°å†™æ“ä½œæµç¨‹
   - æ·»åŠ ç¤ºä¾‹ä»£ç 

3. **æ·»åŠ é…ç½®é€‰é¡¹**
   - `cache.distributed.enabled`
   - `cache.distributed.redisUrl`
   - ç¯å¢ƒæ£€æµ‹é€»è¾‘

### ä¸­æœŸï¼ˆ2-4 å‘¨ï¼‰

1. **å®ç°åˆ†å¸ƒå¼äº‹åŠ¡é”**
   - å®ç° `DistributedCacheLockManager`
   - é›†æˆåˆ° `TransactionManager`
   - æ€§èƒ½æµ‹è¯•

2. **æ·»åŠ ç›‘æ§æŒ‡æ ‡**
   - ç¼“å­˜å¤±æ•ˆå¹¿æ’­å»¶è¿Ÿ
   - é”å†²çªæ¬¡æ•°
   - åˆ†å¸ƒå¼é”ç­‰å¾…æ—¶é—´

3. **å®Œå–„æµ‹è¯•**
   - å¤šå®ä¾‹é›†æˆæµ‹è¯•
   - ç¼“å­˜ä¸€è‡´æ€§æµ‹è¯•
   - äº‹åŠ¡éš”ç¦»æ€§æµ‹è¯•

### é•¿æœŸï¼ˆ1-2 æœˆï¼‰

1. **æ€§èƒ½ä¼˜åŒ–**
   - æ‰¹é‡å¹¿æ’­ç¼“å­˜å¤±æ•ˆ
   - é”ç²’åº¦ä¼˜åŒ–ï¼ˆé›†åˆçº§ â†’ æ–‡æ¡£çº§ï¼‰
   - æœ¬åœ°é” + è¿œç«¯é”æ··åˆæ¨¡å¼

2. **é«˜çº§ç‰¹æ€§**
   - ç¼“å­˜ç‰ˆæœ¬å·æœºåˆ¶
   - åˆ†å¸ƒå¼è¯»å†™é”
   - è‡ªé€‚åº”ç¼“å­˜ç­–ç•¥

---

## ğŸ“– æ–°å¢æ–‡æ¡£å»ºè®®

### 1. åˆ†å¸ƒå¼éƒ¨ç½²æŒ‡å— (docs/distributed-deployment.md)

```markdown
# åˆ†å¸ƒå¼éƒ¨ç½²æŒ‡å—

## æ¶æ„é€‰æ‹©

### å•å®ä¾‹éƒ¨ç½²
- âœ… æ‰€æœ‰åŠŸèƒ½å®Œæ•´æ”¯æŒ
- âœ… æ— éœ€ Redis
- âš ï¸ æ— é«˜å¯ç”¨

### å¤šå®ä¾‹ + æœ¬åœ°ç¼“å­˜
- âš ï¸ ç¼“å­˜ä¸€è‡´æ€§é£é™©
- âŒ ä¸æ¨èç”Ÿäº§ç¯å¢ƒ

### å¤šå®ä¾‹ + Redis + ç¼“å­˜å¹¿æ’­ï¼ˆæ¨èï¼‰
- âœ… é«˜å¯ç”¨
- âœ… ç¼“å­˜ä¸€è‡´æ€§å¥½
- âœ… é€‚åˆå¤§éƒ¨åˆ†åœºæ™¯

### å¤šå®ä¾‹ + ç¦ç”¨ç¼“å­˜
- âœ… å¼ºä¸€è‡´æ€§
- âŒ æ€§èƒ½è¾ƒä½
- âœ… é€‚åˆå¼ºä¸€è‡´æ€§ä¸šåŠ¡
```

### 2. ç¼“å­˜ä¸€è‡´æ€§è¯´æ˜ (docs/cache-consistency.md)

```markdown
# ç¼“å­˜ä¸€è‡´æ€§è¯´æ˜

## å•å®ä¾‹ç¯å¢ƒ

âœ… **å®Œå…¨ä¸€è‡´**: æ‰€æœ‰ç¼“å­˜æ“ä½œåœ¨åŒä¸€è¿›ç¨‹å†…ï¼Œæ— ä¸€è‡´æ€§é—®é¢˜

## å¤šå®ä¾‹ç¯å¢ƒ

### æœ¬åœ°ç¼“å­˜ä¸ä¸€è‡´çª—å£

**é—®é¢˜**ï¼šå†™æ“ä½œåï¼Œå…¶ä»–å®ä¾‹çš„æœ¬åœ°ç¼“å­˜ä¸ä¼šç«‹å³å¤±æ•ˆ

**è§£å†³**ï¼šå¯ç”¨åˆ†å¸ƒå¼ç¼“å­˜å¤±æ•ˆå¹¿æ’­

**é£é™©å¯æ¥å—åœºæ™¯**ï¼š
- æ•°æ®å…è®¸çŸ­æœŸï¼ˆç§’çº§ï¼‰ä¸ä¸€è‡´
- éå…³é”®ä¸šåŠ¡é€»è¾‘
```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### æ–°å¢æµ‹è¯•ç”¨ä¾‹

1. **åˆ†å¸ƒå¼ç¼“å­˜å¤±æ•ˆæµ‹è¯•**
```javascript
// test/integration/distributed-cache.test.js
describe('åˆ†å¸ƒå¼ç¼“å­˜å¤±æ•ˆ', () => {
  it('å®ä¾‹ A å†™å…¥åï¼Œå®ä¾‹ B çš„æœ¬åœ°ç¼“å­˜åº”å¤±æ•ˆ', async () => {
    // åˆ›å»ºä¸¤ä¸ªå®ä¾‹
    const msqA = new MonSQLize({ /* ... */ });
    const msqB = new MonSQLize({ /* ... */ });
    
    // å®ä¾‹ Aã€B éƒ½æŸ¥è¯¢ç”¨æˆ·ï¼ˆç¼“å­˜ï¼‰
    // å®ä¾‹ A æ›´æ–°ç”¨æˆ·
    // å®ä¾‹ B å†æ¬¡æŸ¥è¯¢ï¼Œåº”è¯¥è¯»åˆ°æ–°æ•°æ®
  });
});
```

2. **åˆ†å¸ƒå¼äº‹åŠ¡é”æµ‹è¯•**
```javascript
// test/integration/distributed-transaction.test.js
describe('åˆ†å¸ƒå¼äº‹åŠ¡é”', () => {
  it('å®ä¾‹ A äº‹åŠ¡æœŸé—´ï¼Œå®ä¾‹ B ä¸åº”å†™å…¥è„ç¼“å­˜', async () => {
    // å®ä¾‹ A å¼€å¯äº‹åŠ¡
    // å®ä¾‹ B æŸ¥è¯¢æ•°æ®
    // éªŒè¯å®ä¾‹ B æ²¡æœ‰å†™å…¥ç¼“å­˜
  });
});
```

---

## ğŸ“‹ æ€»ç»“

### å½“å‰çŠ¶æ€

- âœ… **å•å®ä¾‹éƒ¨ç½²**ï¼šå®Œå…¨å¯ç”¨ï¼Œæ‰€æœ‰æœºåˆ¶æœ‰æ•ˆ
- ğŸŸ¡ **å¤šå®ä¾‹ + Redis**ï¼šåŸºæœ¬å¯ç”¨ï¼Œå­˜åœ¨çŸ­æœŸä¸ä¸€è‡´
- ğŸ”´ **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šå­˜åœ¨é£é™©ï¼Œä¸æ¨èä½¿ç”¨

### æ¨èé…ç½®

**å¼€å‘ç¯å¢ƒ**ï¼š
```javascript
cache: {
  maxSize: 1000,
  ttl: 60000
}
```

**ç”Ÿäº§ç¯å¢ƒï¼ˆå•å®ä¾‹ï¼‰**ï¼š
```javascript
cache: {
  maxSize: 10000,
  ttl: 300000
}
```

**ç”Ÿäº§ç¯å¢ƒï¼ˆå¤šå®ä¾‹ï¼‰**ï¼š
```javascript
cache: {
  multiLevel: true,
  local: { maxSize: 1000 },
  remote: MonSQLize.createRedisCacheAdapter('redis://...'),
  distributed: {
    redisUrl: 'redis://...',
    channel: 'app:cache:invalidate'
  }
}
```

**é‡‘è/äº¤æ˜“ç³»ç»Ÿï¼ˆå¤šå®ä¾‹ï¼‰**ï¼š
```javascript
cache: {
  // ç¦ç”¨ç¼“å­˜æˆ–ä»…ç¼“å­˜é™æ€æ•°æ®
  disableInDistributed: true
},
transaction: {
  distributedLock: {
    redis: redisInstance
  }
}
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œï¼ˆP0ï¼‰
1. âœ… å®Œæˆæœ¬åˆ†ææŠ¥å‘Š
2. ğŸ”„ åœ¨æ–‡æ¡£ä¸­æ·»åŠ åˆ†å¸ƒå¼ç¯å¢ƒè­¦å‘Š
3. ğŸ”„ å‡†å¤‡å®æ–½ Pub/Sub æ–¹æ¡ˆ

### è¿‘æœŸæ‰§è¡Œï¼ˆP1ï¼‰
1. å®ç°åˆ†å¸ƒå¼ç¼“å­˜å¤±æ•ˆå¹¿æ’­
2. å®ç°åˆ†å¸ƒå¼äº‹åŠ¡é”
3. æ·»åŠ é›†æˆæµ‹è¯•

### æŒç»­è·Ÿè¿›ï¼ˆP2ï¼‰
1. æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–
2. å®Œå–„æ–‡æ¡£å’Œç¤ºä¾‹
3. ç¤¾åŒºåé¦ˆæ”¶é›†

---

**æŠ¥å‘Šå®Œæˆæ—¥æœŸ**: 2025-11-25  
**åˆ†æäººå‘˜**: AI Assistant  
**å¤å®¡**: å¾…å¤å®¡

