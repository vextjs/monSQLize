/**
 * è‡ªåŠ¨ ObjectId è½¬æ¢ - ä½¿ç”¨ç¤ºä¾‹
 * @description å±•ç¤ºå¦‚ä½•ä½¿ç”¨è‡ªåŠ¨ ObjectId è½¬æ¢åŠŸèƒ½
 */

const MonSQLize = require('../lib');
const { stopMemoryServer } = require('../lib/mongodb/connect');

// ============================================================================
// å¸¸é‡é…ç½®
// ============================================================================

// MongoDB è¿æ¥é…ç½®
// ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ MONGODB_URIï¼Œå¦åˆ™ä½¿ç”?Memory Server
const DB_CONFIG = {
    type: 'mongodb',
    databaseName: 'test_objectid_conversion',
    config: { useMemoryServer: true }
};

// ============================================
// ç¤ºä¾‹1: åŸºç¡€ä½¿ç”¨ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
// ============================================

async function example1_basicUsage() {
    console.log('\n=== ç¤ºä¾‹1: åŸºç¡€ä½¿ç”¨ ===\n');

    const msq = new MonSQLize(DB_CONFIG);

    const { collection } = await msq.connect();

    // âœ?æ‰€æœ‰æ–¹æ³•è‡ªåŠ¨è½¬æ?ObjectId å­—ç¬¦ä¸?

    // æŸ¥è¯¢ï¼šä½¿ç”¨å­—ç¬¦ä¸² _id
    const user = await msq.collection('users').findOne({
        _id: '507f1f77bcf86cd799439011' // âœ?è‡ªåŠ¨è½¬æ¢ä¸?ObjectId
    });
    console.log('æŸ¥è¯¢ç”¨æˆ·:', user);

    // æ’å…¥ï¼šæ–‡æ¡£ä¸­çš?ObjectId å­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ?
    await msq.collection('users').insertOne({
        name: 'Alice',
        managerId: '507f1f77bcf86cd799439012', // âœ?è‡ªåŠ¨è½¬æ¢
        departmentId: '507f1f77bcf86cd799439013' // âœ?è‡ªåŠ¨è½¬æ¢
    });

    // æ›´æ–°ï¼šfilter å’?update ä¸­çš„ ObjectId éƒ½è½¬æ?
    await msq.collection('users').updateOne(
        { _id: '507f1f77bcf86cd799439011' }, // âœ?è‡ªåŠ¨è½¬æ¢
        { $set: { managerId: '507f1f77bcf86cd799439014' } } // âœ?è‡ªåŠ¨è½¬æ¢
    );

    // èšåˆï¼špipeline ä¸­çš„ ObjectId è‡ªåŠ¨è½¬æ¢
    const results = await msq.collection('orders').aggregate([
        { $match: { userId: '507f1f77bcf86cd799439011' } }, // âœ?è‡ªåŠ¨è½¬æ¢
        { $lookup: {
            from: 'users',
            localField: 'userId',
            foreignField: '_id',
            as: 'user'
        }}
    ]);

    await msq.close();
}

// ============================================
// ç¤ºä¾‹2: è§£å†³ ObjectId æ··å­˜é—®é¢˜
// ============================================

async function example2_mixedObjectIds() {
    console.log('\n=== ç¤ºä¾‹2: è§£å†³ ObjectId æ··å­˜é—®é¢˜ ===\n');

    const msq = new MonSQLize(DB_CONFIG);

    const { collection } = await msq.connect();

    // åœºæ™¯ï¼šæ•°æ®åº“ä¸?ObjectId æ··å­˜
    // æœ‰äº›æ–‡æ¡£çš?userId æ˜?ObjectId ç±»å‹
    // æœ‰äº›æ–‡æ¡£çš?userId æ˜?String ç±»å‹

    // é—®é¢˜ï¼šä¹‹å‰éœ€è¦åˆ†åˆ«æŸ¥è¯?
    // const objectIdUsers = await find({ userId: new ObjectId('507f...') });
    // const stringUsers = await find({ userId: '507f...' });

    // âœ?ç°åœ¨ï¼šç»Ÿä¸€ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œè‡ªåŠ¨è½¬æ¢
    const allUsers = await msq.collection('users').find({
        userId: '507f1f77bcf86cd799439011' // è‡ªåŠ¨è½¬æ¢ï¼Œèƒ½åŒ¹é… ObjectId ç±»å‹
    });

    console.log('æ‰¾åˆ°çš„ç”¨æˆ?', allUsers.length);

    // âœ?æ–°æ’å…¥çš„æ•°æ®è‡ªåŠ¨ç»Ÿä¸€ä¸?ObjectId ç±»å‹
    await msq.collection('users').insertOne({
        name: 'Bob',
        userId: '507f1f77bcf86cd799439012' // å­˜å‚¨ä¸?ObjectIdï¼Œç»Ÿä¸€æ•°æ®ç±»å‹
    });

    await msq.close();
}

// ============================================
// ç¤ºä¾‹3: æ‰¹é‡æ“ä½œ
// ============================================

async function example3_batchOperations() {
    console.log('\n=== ç¤ºä¾‹3: æ‰¹é‡æ“ä½œ ===\n');

    const msq = new MonSQLize(DB_CONFIG);

    const { collection } = await msq.connect();

    // æ‰¹é‡æ’å…¥ï¼šæ‰€æœ?ObjectId å­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ?
    const result = await msq.collection('users').insertMany([
        {
            name: 'User1',
            managerId: '507f1f77bcf86cd799439011',
            departmentId: '507f1f77bcf86cd799439012'
        },
        {
            name: 'User2',
            managerId: '507f1f77bcf86cd799439013',
            departmentId: '507f1f77bcf86cd799439012'
        },
        {
            name: 'User3',
            managerId: '507f1f77bcf86cd799439014',
            departmentId: '507f1f77bcf86cd799439015'
        }
    ]);

    console.log('æ’å…¥è®°å½•æ•?', result.insertedCount);

    // æ‰¹é‡æ›´æ–°
    await msq.collection('users').updateMany(
        { departmentId: '507f1f77bcf86cd799439012' }, // âœ?è‡ªåŠ¨è½¬æ¢
        { $set: { status: 'active' } }
    );

    // æ‰¹é‡åˆ é™¤
    await msq.collection('users').deleteMany({
        managerId: '507f1f77bcf86cd799439011' // âœ?è‡ªåŠ¨è½¬æ¢
    });

    await msq.close();
}

// ============================================
// ç¤ºä¾‹4: åµŒå¥—å¯¹è±¡å’Œæ•°ç»?
// ============================================

async function example4_nestedObjects() {
    console.log('\n=== ç¤ºä¾‹4: åµŒå¥—å¯¹è±¡å’Œæ•°ç»?===\n');

    const msq = new MonSQLize(DB_CONFIG);

    const { collection } = await msq.connect();

    // åµŒå¥—å¯¹è±¡ä¸­çš„ ObjectId è‡ªåŠ¨è½¬æ¢
    await msq.collection('users').insertOne({
        name: 'Charlie',
        profile: {
            managerId: '507f1f77bcf86cd799439011', // âœ?è‡ªåŠ¨è½¬æ¢
            settings: {
                defaultProjectId: '507f1f77bcf86cd799439012' // âœ?è‡ªåŠ¨è½¬æ¢
            }
        }
    });

    // æ•°ç»„ä¸­çš„ ObjectId è‡ªåŠ¨è½¬æ¢
    await msq.collection('users').insertOne({
        name: 'David',
        friendIds: [
            '507f1f77bcf86cd799439011', // âœ?è‡ªåŠ¨è½¬æ¢
            '507f1f77bcf86cd799439012', // âœ?è‡ªåŠ¨è½¬æ¢
            '507f1f77bcf86cd799439013'  // âœ?è‡ªåŠ¨è½¬æ¢
        ]
    });

    // æŸ¥è¯¢åµŒå¥—å­—æ®µ
    const users = await msq.collection('users').find({
        'profile.managerId': '507f1f77bcf86cd799439011' // âœ?è‡ªåŠ¨è½¬æ¢
    });

    console.log('æ‰¾åˆ°çš„ç”¨æˆ?', users.length);

    await msq.close();
}

// ============================================
// ç¤ºä¾‹5: è‡ªå®šä¹‰é…ç½?
// ============================================

async function example5_customConfig() {
    console.log('\n=== ç¤ºä¾‹5: è‡ªå®šä¹‰é…ç½?===\n');

    const msq = new MonSQLize({
        ...DB_CONFIG,
        autoConvertObjectId: {
            enabled: true,
            excludeFields: ['code', 'sku'], // ä¸šåŠ¡ç¼–ç å­—æ®µä¸è½¬æ?
            customFieldPatterns: [/^ref.*$/], // è‡ªå®šä¹‰åŒ¹é…æ¨¡å¼?
            maxDepth: 10,
            logLevel: 'warn'
        }
    });

    const { collection } = await msq.connect();

    // code å’?sku å­—æ®µä¸ä¼šè¢«è½¬æ¢ï¼ˆå³ä½¿æ ¼å¼åƒ?ObjectIdï¼?
    await msq.collection('products').insertOne({
        name: 'Product 1',
        code: '507f1f77bcf86cd799439011', // â?ä¸è½¬æ¢ï¼Œä¿æŒå­—ç¬¦ä¸?
        sku: '507f1f77bcf86cd799439012',  // â?ä¸è½¬æ¢ï¼Œä¿æŒå­—ç¬¦ä¸?
        categoryId: '507f1f77bcf86cd799439013' // âœ?è½¬æ¢
    });

    await msq.close();
}

// ============================================
// ç¤ºä¾‹6: ç¦ç”¨è‡ªåŠ¨è½¬æ¢
// ============================================

async function example6_disableConversion() {
    console.log('\n=== ç¤ºä¾‹6: ç¦ç”¨è‡ªåŠ¨è½¬æ¢ ===\n');

    const msq = new MonSQLize({
        ...DB_CONFIG,
        autoConvertObjectId: false // ç¦ç”¨è‡ªåŠ¨è½¬æ¢
    });

    const { collection } = await msq.connect();

    // éœ€è¦æ‰‹åŠ¨è½¬æ?ObjectId
    const { ObjectId } = require('mongodb');

    const user = await msq.collection('users').findOne({
        _id: new ObjectId('507f1f77bcf86cd799439011') // æ‰‹åŠ¨è½¬æ¢
    });

    await msq.close();
}

// ============================================
// ç¤ºä¾‹7: é“¾å¼è°ƒç”¨
// ============================================

async function example7_chainedCalls() {
    console.log('\n=== ç¤ºä¾‹7: é“¾å¼è°ƒç”¨ ===\n');

    const msq = new MonSQLize(DB_CONFIG);

    const { collection } = await msq.connect();

    // é“¾å¼è°ƒç”¨ä¸­çš„ ObjectId è‡ªåŠ¨è½¬æ¢
    const users = await msq.collection('users')
        .find({
            departmentId: '507f1f77bcf86cd799439011' // âœ?è‡ªåŠ¨è½¬æ¢
        })
        .limit(10)
        .sort({ createdAt: -1 });

    console.log('æ‰¾åˆ°çš„ç”¨æˆ?', users.length);

    await msq.close();
}

// ============================================
// ç¤ºä¾‹8: åŸå­æ“ä½œ
// ============================================

async function example8_atomicOperations() {
    console.log('\n=== ç¤ºä¾‹8: åŸå­æ“ä½œ ===\n');

    const msq = new MonSQLize(DB_CONFIG);

    const { collection } = await msq.connect();

    // findOneAndUpdate
    const updatedUser = await msq.collection('users').findOneAndUpdate(
        { _id: '507f1f77bcf86cd799439011' }, // âœ?è‡ªåŠ¨è½¬æ¢
        { $set: { managerId: '507f1f77bcf86cd799439012' } }, // âœ?è‡ªåŠ¨è½¬æ¢
        { returnDocument: 'after' }
    );

    // findOneAndReplace
    const replacedUser = await msq.collection('users').findOneAndReplace(
        { _id: '507f1f77bcf86cd799439011' }, // âœ?è‡ªåŠ¨è½¬æ¢
        {
            name: 'Updated Name',
            managerId: '507f1f77bcf86cd799439013' // âœ?è‡ªåŠ¨è½¬æ¢
        }
    );

    // findOneAndDelete
    const deletedUser = await msq.collection('users').findOneAndDelete({
        _id: '507f1f77bcf86cd799439011' // âœ?è‡ªåŠ¨è½¬æ¢
    });

    await msq.close();
}

// ============================================
// è¿è¡Œæ‰€æœ‰ç¤ºä¾?
// ============================================

async function runAllExamples() {
    try {
        await example1_basicUsage();
        await example2_mixedObjectIds();
        await example3_batchOperations();
        await example4_nestedObjects();
        await example5_customConfig();
        await example6_disableConversion();
        await example7_chainedCalls();
        await example8_atomicOperations();

        console.log('\nâœ?æ‰€æœ‰ç¤ºä¾‹è¿è¡Œå®Œæˆï¼\n');
    } catch (error) {
        console.error('â?ç¤ºä¾‹è¿è¡Œå¤±è´¥:', error);
    }
}

// å¯¼å‡ºç¤ºä¾‹å‡½æ•°
module.exports = {
    example1_basicUsage,
    example2_mixedObjectIds,
    example3_batchOperations,
    example4_nestedObjects,
    example5_customConfig,
    example6_disableConversion,
    example7_chainedCalls,
    example8_atomicOperations,
    runAllExamples
};

// å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»?
if (require.main === module) {
    runAllExamples().catch(console.error);
}

